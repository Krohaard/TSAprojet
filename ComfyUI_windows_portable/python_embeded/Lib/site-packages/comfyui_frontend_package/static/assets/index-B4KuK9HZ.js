var rt=Object.defineProperty;var u=(s,e)=>rt(s,"name",{value:e,configurable:!0});import{r as g,cn as N,co as xe,cp as v,ag as k,aj as B,cq as lt,aF as ae,cr as dt,cs as ct,b2 as Qe,a3 as ut,B as pt,y as M,$ as ht,t as x,G as te,ct as gt,cu as ft,cv as R,cw as L,cx as mt,cy as _e,cz as yt,cA as wt,cB as bt,cC as Fe,a8 as ee,cD as U,cE as j,ay as le,cF as et,cG as oe,cH as vt,cI as Ct,cJ as W,F as _t,cK as kt,V as Nt,a as O,cL as tt,as as It,cM as xt,az as Dt,u as Q,cN as V,at as Tt,j as ot,ck as Et,cl as de,cm as ne,cO as De,cP as Te,cQ as St,cR as Mt,cS as Ot,T as We,cT as At,bK as Pt,cU as Lt,cV as Rt,cW as Ft,cX as Wt}from"./index-UkVvUXbW.js";import{cr as Be,cz as q,n as Ee,ev as Bt,er as Ut}from"./vendor-other-CcUSxTdr.js";import{l as Gt}from"./mathUtil-DlGw4Aca.js";import{_ as Se}from"./Load3D.vue_vue_type_script_setup_true_lang-Cnkq3Aau.js";import{g as ce,s as it}from"./audioUtils-Cdppfz5B.js";import{u as Z}from"./audioService-CU-oljo0.js";import"./vendor-primevue-D4_dEx5Z.js";import"./vendor-vue-BFtl7jfJ.js";import"./vendor-xterm-DV1MVhAx.js";import"./vendor-three-zdhtZbSm.js";import"./vendor-tiptap-BLQhG9Oo.js";class S extends xe{static{u(this,"ClipspaceDialog")}static items=[];static instance=null;static registerButton(e,t,o){const i=v("button",{type:"button",textContent:e,contextPredicate:t,onclick:o});S.items.push(i)}static invalidatePreview(){if(N.clipspace&&N.clipspace.imgs&&N.clipspace.imgs.length>0){const e=document.getElementById("clipspace_preview");e&&(e.src=N.clipspace.imgs[N.clipspace.selectedIndex].src,e.style.maxHeight="100%",e.style.maxWidth="100%")}}static invalidate(){if(S.instance){const e=S.instance,t=v("div.comfy-modal-content",[e.createImgSettings(),...e.createButtons()]);e.element?(e.element.firstChild&&e.element.removeChild(e.element.firstChild),e.element.appendChild(t)):e.element=v("div.comfy-modal",{parent:document.body},[t]),e.element.children[0].children.length<=1&&e.element.children[0].appendChild(v("p",{},["Unable to find the features to edit content of a format stored in the current Clipspace."])),S.invalidatePreview()}}constructor(){super()}createButtons(){const e=[];for(let t in S.items){const o=S.items[t];(!o.contextPredicate||o.contextPredicate())&&e.push(S.items[t])}return e.push(v("button",{type:"button",textContent:"Close",onclick:u(()=>{this.close()},"onclick")})),e}createImgSettings(){if(N.clipspace?.imgs){const e=[],t=N.clipspace.imgs;for(let c=0;c<t.length;c++)e.push(v("option",{value:c},[`${c}`]));const o=v("select",{id:"clipspace_img_selector",onchange:u(c=>{c.target&&N.clipspace&&(N.clipspace.selectedIndex=c.target.selectedIndex,S.invalidatePreview())},"onchange")},e),i=v("tr",{},[v("td",{},[v("font",{color:"white"},["Select Image"])]),v("td",{},[o])]),n=v("select",{id:"clipspace_img_paste_mode",onchange:u(c=>{c.target&&N.clipspace&&(N.clipspace.img_paste_mode=c.target.value)},"onchange")},[v("option",{value:"selected"},"selected"),v("option",{value:"all"},"all")]);n.value=N.clipspace.img_paste_mode;const a=v("tr",{},[v("td",{},[v("font",{color:"white"},["Paste Mode"])]),v("td",{},[n])]),r=v("td",{align:"center",width:"100px",height:"100px",colSpan:"2"},[v("img",{id:"clipspace_preview",ondragstart:u(()=>!1,"ondragstart")},[])]),l=v("tr",{},[r]);return v("table",{},[i,a,l])}else return[]}createImgPreview(){return N.clipspace?.imgs?v("img",{id:"clipspace_preview",ondragstart:u(()=>!1,"ondragstart")}):[]}show(){S.invalidate(),this.element.style.display="block"}}g.registerExtension({name:"Comfy.Clipspace",init(s){s.openClipspace=function(){S.instance||(S.instance=new S,N.clipspace_invalidate_handler=S.invalidate),N.clipspace?S.instance.show():s.ui.dialog.show("Clipspace is Empty!")}}});window.comfyAPI=window.comfyAPI||{};window.comfyAPI.clipspace=window.comfyAPI.clipspace||{};window.comfyAPI.clipspace.ClipspaceDialog=S;const zt={name:"Comfy.ContextMenuFilter",init(){const s=k.ContextMenu;k.ContextMenu=function(e,t){const o=new s(e,t);if(t?.className==="dark"&&e?.length>4){const i=document.createElement("input");i.classList.add("comfy-context-menu-filter"),i.placeholder="Filter list",o.root.prepend(i);const n=Array.from(o.root.querySelectorAll(".litemenu-entry"));let a=[...n],r=a.length;requestAnimationFrame(()=>{const c=B.active_canvas.current_node?.widgets?.filter(f=>lt(f)&&f.options.values?.length===e.length).find(f=>f.options.values?.every((m,y)=>m===e[y]))?.value;let d=c?e.findIndex(f=>f===c):0;d<0&&(d=0);let h=a[d];b();function b(){h?.style.setProperty("background-color",""),h?.style.setProperty("color",""),h=a[d],h?.style.setProperty("background-color","#ccc","important"),h?.style.setProperty("color","#000","important")}u(b,"updateSelected");const p=u(()=>{if(o.root.getBoundingClientRect().top<0){const m=1-o.root.getBoundingClientRect().height/o.root.clientHeight,y=o.root.clientHeight*m/2;o.root.style.top=-y+"px"}},"positionList");i.addEventListener("keydown",f=>{switch(f.key){case"ArrowUp":f.preventDefault(),d===0?d=r-1:d--,b();break;case"ArrowRight":f.preventDefault(),d=r-1,b();break;case"ArrowDown":f.preventDefault(),d===r-1?d=0:d++,b();break;case"ArrowLeft":f.preventDefault(),d=0,b();break;case"Enter":h?.click();break;case"Escape":o.close();break}}),i.addEventListener("input",()=>{const f=i.value.toLocaleLowerCase();if(a=n.filter(m=>{const y=!f||m.textContent?.toLocaleLowerCase().includes(f);return m.style.display=y?"block":"none",y}),d=0,a.includes(h)&&(d=a.findIndex(m=>m===h)),r=a.length,b(),t.event){let m=t.event.clientY-10;const y=document.body.getBoundingClientRect(),w=o.root.getBoundingClientRect();y.height&&m>y.height-w.height-10&&(m=Math.max(0,y.height-w.height-10)),o.root.style.top=m+"px",p()}}),requestAnimationFrame(()=>{i.focus(),p()})})}return o},k.ContextMenu.prototype=s.prototype}};g.registerExtension(zt);ae().registerExtension({name:"Comfy.DynamicPrompts",nodeCreated(s){if(s.widgets){const e=s.widgets.filter(t=>t.dynamicPrompts);for(const t of e)t.serializeValue=(o,i)=>{if(typeof t.value!="string")return t.value;const n=dt(t.value);return o?.widgets_values&&(o.widgets_values[i]=n),n}}}});g.registerExtension({name:"Comfy.EditAttention",init(){const s=g.ui.settings.addSetting({id:"Comfy.EditAttention.Delta",category:["Comfy","EditTokenWeight","Delta"],name:"Ctrl+up/down precision",type:"slider",attrs:{min:.01,max:.5,step:.01},defaultValue:.05});function e(n,a){const r=parseFloat(n);if(isNaN(r))return n;const l=r+a;return String(Number(l.toFixed(10)))}u(e,"incrementWeight");function t(n,a){let r=a,l=a,c=0,d=0;for(;r>=0&&(r--,!(n[r]==="("&&c===d));)n[r]==="("&&c++,n[r]===")"&&d++;if(r<0)return null;for(c=0,d=0;l<n.length&&!(n[l]===")"&&c===d);)n[l]==="("&&c++,n[l]===")"&&d++,l++;return l===n.length?null:{start:r+1,end:l}}u(t,"findNearestEnclosure");function o(n){const a=/^\((.*)\)$/,r=n.match(a),l=/:([+-]?(\d*\.)?\d+([eE][+-]?\d+)?)/,c=n.match(l);return r&&!c?`(${r[1]}:1.0)`:n}u(o,"addWeightToParentheses");function i(n){const a=n.composedPath()[0],r=parseFloat(s.value);if(a.tagName!=="TEXTAREA"||!(n.key==="ArrowUp"||n.key==="ArrowDown")||!n.ctrlKey&&!n.metaKey)return;n.preventDefault();let l=a.selectionStart,c=a.selectionEnd,d=a.value.substring(l,c);if(!d){const p=t(a.value,l);if(p)l=p.start,c=p.end,d=a.value.substring(l,c);else{const f=" .,\\/!?%^*;:{}=-_`~()\r\n	";for(;!f.includes(a.value[l-1])&&l>0;)l--;for(;!f.includes(a.value[c])&&c<a.value.length;)c++;if(d=a.value.substring(l,c),!d)return}}d[d.length-1]===" "&&(d=d.substring(0,d.length-1),c-=1),a.value[l-1]==="("&&a.value[c]===")"&&(l-=1,c+=1,d=a.value.substring(l,c)),(d[0]!=="("||d[d.length-1]!==")")&&(d=`(${d})`),d=o(d);const h=n.key==="ArrowUp"?r:-r,b=d.replace(/\((.*):([+-]?\d+(?:\.\d+)?)\)/,(p,f,m)=>(m=e(m,h),m==1?f:`(${f}:${m})`));a.setSelectionRange(l,c),document.execCommand("insertText",!1,b),a.setSelectionRange(l,l+b.length)}u(i,"editAttention"),window.addEventListener("keydown",i)}});const Vt={settingId:"Comfy-Desktop.UV.PythonInstallMirror",mirror:"https://github.com/astral-sh/python-build-standalone/releases/download",fallbackMirror:"https://python-standalone.org/mirror/astral-sh/python-build-standalone",validationPathSuffix:"/20250115/cpython-3.10.16+20250115-aarch64-apple-darwin-debug-full.tar.zst.sha256"},ye=u(async s=>ct(s)&&await Qe().NetWork.canAccessUrl(s),"checkMirrorReachable");(async()=>{if(!ut())return;const s=Qe(),e=await s.getElectronVersion(),t=pt(),o=M(),{staticUrls:i,buildDocsUrl:n}=ht(),a=u((r,l)=>{l!==void 0&&r!==l&&s.restartApp("Restart ComfyUI to apply changes.",1500)},"onChangeRestartApp");g.registerExtension({name:"Comfy.ElectronAdapter",settings:[{id:"Comfy-Desktop.AutoUpdate",category:["Comfy-Desktop","General","AutoUpdate"],name:"Automatically check for updates",type:"boolean",defaultValue:!0,onChange:a},{id:"Comfy-Desktop.SendStatistics",category:["Comfy-Desktop","General","Send Statistics"],name:"Send anonymous usage metrics",type:"boolean",defaultValue:!0,onChange:a},{id:"Comfy-Desktop.WindowStyle",category:["Comfy-Desktop","General","Window Style"],name:"Window Style",tooltip:"Custom: Replace the system title bar with ComfyUI's Top menu",type:"combo",experimental:!0,defaultValue:"default",options:["default","custom"],onChange:u((r,l)=>{l&&s.Config.setWindowStyle(r)},"onChange")},{id:"Comfy-Desktop.UV.PythonInstallMirror",name:"Python Install Mirror",tooltip:"Managed Python installations are downloaded from the Astral python-build-standalone project. This variable can be set to a mirror URL to use a different source for Python installations. The provided URL will replace https://github.com/astral-sh/python-build-standalone/releases/download in, e.g., https://github.com/astral-sh/python-build-standalone/releases/download/20240713/cpython-3.12.4%2B20240713-aarch64-apple-darwin-install_only.tar.gz. Distributions can be read from a local directory by using the file:// URL scheme.",type:"url",defaultValue:"",attrs:{validateUrlFn(r){return ye(r+Vt.validationPathSuffix)}}},{id:"Comfy-Desktop.UV.PypiInstallMirror",name:"Pypi Install Mirror",tooltip:"Default pip install mirror",type:"url",defaultValue:"",attrs:{validateUrlFn:ye}},{id:"Comfy-Desktop.UV.TorchInstallMirror",name:"Torch Install Mirror",tooltip:"Pip install mirror for pytorch",type:"url",defaultValue:"",attrs:{validateUrlFn:ye}}],commands:[{id:"Comfy-Desktop.Folders.OpenLogsFolder",label:"Open Logs Folder",icon:"pi pi-folder-open",function(){s.openLogsFolder()}},{id:"Comfy-Desktop.Folders.OpenModelsFolder",label:"Open Models Folder",icon:"pi pi-folder-open",function(){s.openModelsFolder()}},{id:"Comfy-Desktop.Folders.OpenOutputsFolder",label:"Open Outputs Folder",icon:"pi pi-folder-open",function(){s.openOutputsFolder()}},{id:"Comfy-Desktop.Folders.OpenInputsFolder",label:"Open Inputs Folder",icon:"pi pi-folder-open",function(){s.openInputsFolder()}},{id:"Comfy-Desktop.Folders.OpenCustomNodesFolder",label:"Open Custom Nodes Folder",icon:"pi pi-folder-open",function(){s.openCustomNodesFolder()}},{id:"Comfy-Desktop.Folders.OpenModelConfig",label:"Open extra_model_paths.yaml",icon:"pi pi-file",function(){s.openModelConfig()}},{id:"Comfy-Desktop.OpenDevTools",label:"Open DevTools",icon:"pi pi-code",function(){s.openDevTools()}},{id:"Comfy-Desktop.OpenUserGuide",label:"Desktop User Guide",icon:"pi pi-book",function(){window.open(n("/installation/desktop",{includeLocale:!0,platform:!0}),"_blank")}},{id:"Comfy-Desktop.CheckForUpdates",label:"Check for Updates",icon:"pi pi-sync",async function(){try{const r=await s.checkForUpdates({disableUpdateReadyAction:!0});if(!r.isUpdateAvailable){o.add({severity:"info",summary:x("desktopUpdate.noUpdateFound"),life:5e3});return}if(await te().confirm({title:x("desktopUpdate.updateFoundTitle",{version:r.version}),message:x("desktopUpdate.updateAvailableMessage"),type:"default"}))try{s.restartAndInstall()}catch(c){Be.error("Error installing update:",c),o.add({severity:"error",summary:x("g.error"),detail:x("desktopUpdate.errorInstallingUpdate"),life:1e4})}}catch(r){Be.error("Error checking for updates:",r),o.add({severity:"error",summary:x("g.error"),detail:x("desktopUpdate.errorCheckingUpdate"),life:1e4})}}},{id:"Comfy-Desktop.Reinstall",label:"Reinstall",icon:"pi pi-refresh",async function(){await te().confirm({message:x("desktopMenu.confirmReinstall"),title:x("desktopMenu.reinstall"),type:"reinstall"})&&s.reinstall()}},{id:"Comfy-Desktop.Restart",label:"Restart",icon:"pi pi-refresh",function(){s.restartApp()}},{id:"Comfy-Desktop.Quit",label:"Quit",icon:"pi pi-sign-out",async function(){t.modifiedWorkflows.length>0&&!await te().confirm({message:x("desktopMenu.confirmQuit"),title:x("desktopMenu.quit"),type:"default"})||s.quit()}}],menuCommands:[{path:["Help"],commands:["Comfy-Desktop.OpenUserGuide"]},{path:["Help"],commands:["Comfy-Desktop.OpenDevTools"]},{path:["Help","Open Folder"],commands:["Comfy-Desktop.Folders.OpenLogsFolder","Comfy-Desktop.Folders.OpenModelsFolder","Comfy-Desktop.Folders.OpenOutputsFolder","Comfy-Desktop.Folders.OpenInputsFolder","Comfy-Desktop.Folders.OpenCustomNodesFolder","Comfy-Desktop.Folders.OpenModelConfig"]},{path:["Help"],commands:["Comfy-Desktop.CheckForUpdates","Comfy-Desktop.Reinstall"]}],keybindings:[{commandId:"Workspace.CloseWorkflow",combo:{key:"w",ctrl:!0}}],aboutPageBadges:[{label:"ComfyUI_desktop v"+e,url:i.githubElectron,icon:"pi pi-github"}]})})();class $t extends gt{static{u(this,"ExecutableGroupNodeChildDTO")}groupNodeHandler;constructor(e,t,o,i,n){super(e,t,o,i),this.groupNodeHandler=n}resolveInput(e){if(this.id.split(":").length>2)throw new Error("Group nodes inside subgraphs are not supported. Please convert the group node to a subgraph instead.");const t=this.node.getInputNode(e);if(!t)return;const o=this.node.getInputLink(e);if(!o)throw new Error("Failed to get input link");const i=String(t.id);let n=this.nodesByExecutionId?.get(i);if(!n){const a=i.split(":").at(-1);a!==void 0&&(n=this.nodesByExecutionId?.get(a))}if(!n)throw new Error(`Failed to get input node ${i} for group node child ${this.id} with slot ${e}`);return{node:n,origin_id:i,origin_slot:o.origin_slot}}}const we=Symbol();function nt(s,e){if(typeof s=="object"&&typeof e=="object")for(const t in e){const o=e[t];if(typeof o=="object"){let i=s[t];i||(i=s[t]={}),nt(i,e[t])}else s[t]=o}return s}u(nt,"merge");class st extends ft{static{u(this,"ManageGroupDialog")}tabs;selectedNodeIndex;selectedTab="Inputs";selectedGroup;modifications={};nodeItems;app;groupNodeType;groupNodeDef;groupData;innerNodesList;widgetsPage;inputsPage;outputsPage;draggable;get selectedNodeInnerIndex(){return+this.nodeItems[this.selectedNodeIndex].dataset.nodeindex}constructor(e){super(),this.app=e,this.element=v("dialog.comfy-group-manage",{parent:document.body})}changeTab(e){this.tabs[this.selectedTab].tab.classList.remove("active"),this.tabs[this.selectedTab].page.classList.remove("active"),this.tabs[e].tab.classList.add("active"),this.tabs[e].page.classList.add("active"),this.selectedTab=e}changeNode(e,t){!t&&this.selectedNodeIndex===e||(this.selectedNodeIndex!=null&&this.nodeItems[this.selectedNodeIndex].classList.remove("selected"),this.nodeItems[e].classList.add("selected"),this.selectedNodeIndex=e,!this.buildInputsPage()&&this.selectedTab==="Inputs"&&this.changeTab("Widgets"),!this.buildWidgetsPage()&&this.selectedTab==="Widgets"&&this.changeTab("Outputs"),!this.buildOutputsPage()&&this.selectedTab==="Outputs"&&this.changeTab("Inputs"),this.changeTab(this.selectedTab))}getGroupData(){this.groupNodeType=k.registered_node_types[`${R}${L}`+this.selectedGroup],this.groupNodeDef=this.groupNodeType.nodeData,this.groupData=G.getGroupData(this.groupNodeType)}changeGroup(e,t=!0){this.selectedGroup=e,this.getGroupData();const o=this.groupData.nodeData.nodes;if(this.nodeItems=o.map((n,a)=>v("li.draggable-item",{dataset:{nodeindex:n.index+""},onclick:u(()=>{this.changeNode(a)},"onclick")},[v("span.drag-handle"),v("div",{textContent:n.title??n.type},n.title?v("span",{textContent:n.type}):[])])),this.innerNodesList.replaceChildren(...this.nodeItems),t)this.selectedNodeIndex=null,this.changeNode(0);else{let a=this.draggable.getAllItems().findIndex(r=>r.classList.contains("selected"));a===-1&&(a=this.selectedNodeIndex),this.changeNode(a,!0)}const i=[...o];this.draggable?.dispose(),this.draggable=new mt(this.innerNodesList,"li"),this.draggable.addEventListener("dragend",({detail:{oldPosition:n,newPosition:a}})=>{if(n!==a){i.splice(a,0,i.splice(n,1)[0]);for(let r=0;r<i.length;r++)this.storeModification({nodeIndex:i[r].index,section:we,prop:"order",value:r})}})}storeModification(e){const{nodeIndex:t,section:o,prop:i,value:n}=e,a=this.modifications[this.selectedGroup]??={},r=a.nodes??={},l=r[t??this.selectedNodeInnerIndex]??={},c=l[o]??={};if(typeof n=="object"){const d=c[i]??={};Object.assign(d,n)}else c[i]=n}getEditElement(e,t,o,i,n,a=!0){o===i&&(o="");const r=this.modifications[this.selectedGroup]?.nodes?.[this.selectedNodeInnerIndex]?.[e]?.[t];return r&&(r.name!=null&&(o=r.name),r.visible!=null&&(n=r.visible)),v("div",[v("input",{value:o,placeholder:i,type:"text",onchange:u(l=>{this.storeModification({section:e,prop:t,value:{name:l.target.value}})},"onchange")}),v("label",{textContent:"Visible"},[v("input",{type:"checkbox",checked:n,disabled:!a,onchange:u(l=>{this.storeModification({section:e,prop:t,value:{visible:!!l.target.checked}})},"onchange")})])])}buildWidgetsPage(){const e=this.groupData.oldToNewWidgetMap[this.selectedNodeInnerIndex],t=Object.keys(e??{}),i=g.graph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.input;return this.widgetsPage.replaceChildren(...t.map(n=>this.getEditElement("input",n,e[n],n,i?.[n]?.visible!==!1))),!!t.length}buildInputsPage(){const e=this.groupData.nodeInputs[this.selectedNodeInnerIndex],t=Object.keys(e??{}),i=g.graph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.input;return this.inputsPage.replaceChildren(...t.map(n=>{let a=e[n];if(a)return this.getEditElement("input",n,a,n,i?.[n]?.visible!==!1)}).filter(Boolean)),!!t.length}buildOutputsPage(){const e=this.groupData.nodeData.nodes,t=this.groupData.getNodeDef(e[this.selectedNodeInnerIndex]),o=t?.output??[],i=this.groupData.oldToNewOutputMap[this.selectedNodeInnerIndex],a=g.graph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.output,l=this.groupData.nodeData.nodes[this.selectedNodeInnerIndex].type!=="PrimitiveNode";return this.outputsPage.replaceChildren(...o.map((c,d)=>{const h=i?.[d],b=t.output_name?.[d]??c;let p=a?.[d]?.name;const f=a?.[d]?.visible||h!=null;return(!p||p===b)&&(p=""),this.getEditElement("output",d,p,b,f,l)}).filter(Boolean)),!!o.length}show(e){const t=Object.keys(g.graph.extra?.groupNodes??{}).sort((n,a)=>n.localeCompare(a));this.innerNodesList=v("ul.comfy-group-manage-list-items"),this.widgetsPage=v("section.comfy-group-manage-node-page"),this.inputsPage=v("section.comfy-group-manage-node-page"),this.outputsPage=v("section.comfy-group-manage-node-page");const o=v("div",[this.widgetsPage,this.inputsPage,this.outputsPage]);this.tabs=[["Inputs",this.inputsPage],["Widgets",this.widgetsPage],["Outputs",this.outputsPage]].reduce((n,[a,r])=>(n[a]={tab:v("a",{onclick:u(()=>{this.changeTab(a)},"onclick"),textContent:a}),page:r},n),{});const i=v("div.comfy-group-manage-outer",[v("header",[v("h2","Group Nodes"),v("select",{onchange:u(n=>{this.changeGroup(n.target.value)},"onchange")},t.map(n=>v("option",{textContent:n,selected:`${R}${L}${n}`===e,value:n})))]),v("main",[v("section.comfy-group-manage-list",this.innerNodesList),v("section.comfy-group-manage-node",[v("header",Object.values(this.tabs).map(n=>n.tab)),o])]),v("footer",[v("button.comfy-btn",{onclick:u(()=>{if(g.graph.nodes.find(a=>a.type===`${R}${L}`+this.selectedGroup)){M().addAlert("This group node is in use in the current workflow, please first remove these.");return}confirm(`Are you sure you want to remove the node: "${this.selectedGroup}"`)&&(delete g.graph.extra.groupNodes[this.selectedGroup],k.unregisterNodeType(`${R}${L}`+this.selectedGroup)),this.show()},"onclick")},"Delete Group Node"),v("button.comfy-btn",{onclick:u(async()=>{let n,a=[];const r={};for(const l in this.modifications){const c=g.graph.extra.groupNodes[l];let d=c.config??={},h=this.modifications[l]?.nodes;if(h){const p=Object.keys(h);if(h[p[0]][we]){const f=[],m={},y={};for(const w of p){const C=h[w][we].order;f[C]=c.nodes[+w],m[C]=h[w],f[C].index=C}for(const w of c.links)w[0]!=null&&(w[0]=c.nodes[w[0]].index),w[2]!=null&&(w[2]=c.nodes[w[2]].index);if(c.external)for(const w of c.external)w[0]=c.nodes[w[0]];for(const w of p)d[w]&&(y[c.nodes[w].index]=d[w]),delete d[w];c.nodes=f,h=m,c.config=d=y}nt(d,h)}r[l]=c,n||(n=g.graph.nodes.reduce((p,f)=>(p[f.type]??=[],p[f.type].push(f),p),{}));const b=n[`${R}${L}`+l];b&&a.push(...b)}await X.registerFromWorkflow(r,{});for(const l of a)l.recreate();this.modifications={},this.app.graph.setDirtyCanvas(!0,!0),this.changeGroup(this.selectedGroup,!1)},"onclick")},"Save"),v("button.comfy-btn",{onclick:u(()=>this.element.close(),"onclick")},"Close")])]);this.element.replaceChildren(i),this.changeGroup(e?t.find(n=>`${R}${L}${n}`===e)??t[0]:t[0]),this.element.showModal(),this.element.addEventListener("close",()=>{this.draggable?.dispose(),this.element.remove()})}}window.comfyAPI=window.comfyAPI||{};window.comfyAPI.groupNodeManage=window.comfyAPI.groupNodeManage||{};window.comfyAPI.groupNodeManage.ManageGroupDialog=st;const jt=new Set(["default","forceInput","defaultInput","control_after_generate","multiline","tooltip","dynamicPrompts"]),Ue=u(s=>{const e=s.min??-1/0,t=s.max??1/0;return{min:e,max:t}},"getRange"),Yt=u((s,e)=>{const t=s[0],o=s[1]??{},i=e[1]??{},n=Ue(o),a=Ue(i);if(n.min>a.max||n.max<a.min)return null;const r=o.step??1,l=i.step??1,c={min:Math.max(n.min,a.min),max:Math.min(n.max,a.max),step:Gt(r,l)};return Me([t,{...o,...c}],[t,{...i,...c}])},"mergeNumericInputSpec"),qt=u((s,e)=>{const t=s[1]??{},o=e[1]??{},i=Fe(s),n=Fe(e),a=q.intersection(i,n);return a.length===0?null:Me(["COMBO",{...t,options:a}],["COMBO",{...o,options:a}])},"mergeComboInputSpec"),Me=u((s,e)=>{const t=_e(s),o=s[1]??{},i=e[1]??{};return q.union(q.keys(o),q.keys(i)).filter(r=>!jt.has(r)).every(r=>{const l=o[r],c=i[r];return l===c||q.isNil(l)&&q.isNil(c)})?[t,{...o,...i}]:null},"mergeCommonInputSpec"),Ht=u((s,e)=>{const t=_e(s),o=_e(e);return t!==o?null:yt(s)||wt(s)?Yt(s,e):bt(s)?qt(s,e):Me(s,e)},"mergeInputSpec"),Xt=u(s=>s.type==="PrimitiveNode","isPrimitiveNode"),be="Run widget replace on values";class ke extends le{static{u(this,"PrimitiveNode")}controlValues;lastType;static category;constructor(e){super(e),this.addOutput("connect to widget input","*"),this.serialize_widgets=!0,this.isVirtualNode=!0,(!this.properties||!(be in this.properties))&&this.addProperty(be,!1,"boolean")}applyToGraph(e=[]){if(!this.outputs[0].links?.length||!this.graph)return;const t=[...this.outputs[0].links.map(i=>this.graph.links[i]),...e];let o=this.widgets?.[0].value;o&&this.properties[be]&&(o=et(this.graph,o));for(const i of t){const n=this.graph?.getNodeById(i.target_id),a=n?.inputs[i.target_slot];if(!a){console.warn("Unable to resolve node or input for link",i);continue}const r=a.widget?.name;if(!r){console.warn("Invalid widget or widget name",a.widget);continue}const l=n.widgets?.find(c=>c.name===r);if(!l){console.warn(`Unable to find widget "${r}" on node [${n.id}]`);continue}l.value=o,l.callback?.(l.value,g.canvas,n,g.canvas.graph_mouse,{})}}refreshComboInNode(){const e=this.widgets?.[0];e?.type==="combo"&&(e.options.values=this.outputs[0].widget[U]()[0],e.options.values.includes(e.value)||(e.value=e.options.values[0],e.callback(e.value)))}onAfterGraphConfigured(){if(this.outputs[0].links?.length&&!this.widgets?.length){if(this.#e(),this.widgets&&this.widgets_values)for(let e=0;e<this.widgets_values.length;e++){const t=this.widgets[e];t&&(t.value=this.widgets_values[e])}this.#t()}}onConnectionsChange(e,t,o){if(g.configuringGraph)return;const i=this.outputs[0].links;o?i?.length&&!this.widgets?.length&&this.#e():(this.#t(),i?.length||this.onLastDisconnect())}onConnectOutput(e,t,o,i,n){if(!o.widget&&!(o.type in j))return!1;if(this.outputs[e].links?.length){const a=this.#o(o);return a&&this.applyToGraph([{target_id:i.id,target_slot:n}]),a}return!0}#e(e){if(!this.outputs[0].links||!this.graph){this.onLastDisconnect();return}const t=this.outputs[0].links[0],o=this.graph.links[t];if(!o)return;const i=this.graph.getNodeById(o.target_id);if(!i||!i.inputs)return;const n=i.inputs[o.target_slot];if(!n)return;let a;if(n.widget)a=n.widget;else{if(!(n.type in j))return;a={name:n.name,[U]:()=>[n.type,{}]}}const r=a[U]?.();if(!r)return;const{type:l}=Jt(r);this.outputs[0].type=l,this.outputs[0].name=l,this.outputs[0].widget=a,this.#n(a[oe]??r,i,a.name,e)}#n(e,t,o,i){let n=e[0];n instanceof Array&&(n="COMBO");const[a,r]=this.size;let l;if(n in j?l=(j[n](this,"value",e,g)||{}).widget:l=this.addWidget(n,"value",null,()=>{},{}),t?.widgets&&l){const d=t.widgets.find(h=>h.name===o);d&&(l.value=d.value)}if(!e?.[1]?.control_after_generate&&(l.type==="number"||l.type==="combo")){let d=this.widgets_values?.[1];d||(d="fixed"),vt(this,l,d,void 0,e);let h=this.widgets_values?.[2];h&&this.widgets&&this.widgets.length===3&&(this.widgets[2].value=h)}const c=this.controlValues;if(this.widgets&&this.lastType===this.widgets[0]?.type&&c?.length===this.widgets.length-1)for(let d=0;d<c.length;d++)this.widgets[d+1].value=c[d];if(l.callback=ee(l.callback,()=>{this.applyToGraph()}),this.setSize([Math.max(this.size[0],a),Math.max(this.size[1],r)]),!i){const d=this.computeSize();this.size[0]<d[0]&&(this.size[0]=d[0]),this.size[1]<d[1]&&(this.size[1]=d[1]),requestAnimationFrame(()=>{this.onResize?.(this.size)})}}recreateWidget(){const e=this.widgets?.map(t=>t.value);if(this.#i(),this.#e(!0),e?.length&&this.widgets)for(let t=0;t<this.widgets.length;t++)this.widgets[t].value=e[t];return this.widgets?.[0]}#t(){const e=this.outputs[0],t=e.links??[],o=!!e.widget?.[oe];if(o&&delete e.widget?.[oe],t?.length<2&&o){t.length&&this.recreateWidget();return}const i=e.widget?.[U]?.();if(!(!i||!(i[0]==="INT"||i[0]==="FLOAT")||!this.graph))for(const a of t){const r=this.graph.links[a];if(!r)continue;const l=this.graph.getNodeById(r.target_id);if(!l)continue;const c=l.inputs[r.target_slot];this.#o(c,o)}}#o(e,t){const o=this.outputs?.[0],i=e.widget?.[U]?.();return i?!!se.call(this,o,i,t,this.recreateWidget):!1}#i(){if(this.widgets){for(const e of this.widgets)e.onRemove&&e.onRemove();this.controlValues=[],this.lastType=this.widgets[0]?.type;for(let e=1;e<this.widgets.length;e++)this.controlValues.push(this.widgets[e].value);setTimeout(()=>{delete this.lastType,delete this.controlValues},15),this.widgets.length=0}}onLastDisconnect(){this.outputs[0].type="*",this.outputs[0].name="connect to widget input",delete this.outputs[0].widget,this.#i()}}function Oe(s){return s.widget?.[oe]??s.widget?.[U]?.()??["*",{}]}u(Oe,"getWidgetConfig");function Ge(s){const{nodeData:e}=this.constructor;return e?.input?.required?.[s]??e?.input?.optional?.[s]}u(Ge,"getConfig");function Kt(s,e){return console.warn("Please remove call to convertToInput. Widget to socket conversion is no longer necessary, as they co-exist now."),s.inputs.find(t=>t.widget?.name===e.name)}u(Kt,"convertToInput");function Jt(s){let e=s[0];return e instanceof Array&&(e="COMBO"),{type:e}}u(Jt,"getWidgetType");function Ne(s,e){if(!s.widget||(e?s.widget[U]=()=>e:delete s.widget,!(s instanceof Ct)))return;const t=s.node.graph;if(!t)return;const o=t.links[s.link??-1];if(!o)return;const i=t.getNodeById(o.origin_id);!i||!Xt(i)||(e?i.recreateWidget():g.configuringGraph||(i.disconnectOutput(0),i.onLastDisconnect()))}u(Ne,"setWidgetConfig");function se(s,e,t,o,i){i||(i=Oe(s));const n=Ht(i,e);if(n||t){n&&(s.widget[oe]=n);const a=o?.call(this);if(a){const r=a.options.min,l=a.options.max;r!=null&&a.value<r&&(a.value=r),l!=null&&a.value>l&&(a.value=l),a.callback(a.value)}}return{customConfig:n?.[1]??{}}}u(se,"mergeIfValid");g.registerExtension({name:"Comfy.WidgetInputs",async beforeRegisterNodeDef(s,e,t){s.prototype.convertWidgetToInput=function(){return console.warn("Please remove call to convertWidgetToInput. Widget to socket conversion is no longer necessary, as they co-exist now."),!1},s.prototype.onGraphConfigured=ee(s.prototype.onGraphConfigured,function(){if(this.inputs){this.widgets??=[];for(const i of this.inputs)if(i.widget){const n=i.widget.name;i.widget[U]||(i.widget[U]=()=>Ge.call(this,n)),this.widgets?.find(r=>r.name===n)||this.removeInput(this.inputs.findIndex(r=>r===i))}}}),s.prototype.onConfigure=ee(s.prototype.onConfigure,function(){if(!t.configuringGraph&&this.inputs){for(const i of this.inputs)if(i.widget&&!i.widget[U]){const n=i.widget.name;i.widget[U]=()=>Ge.call(this,n)}}});const o=s.prototype.onInputDblClick;s.prototype.onInputDblClick=function(...[i,...n]){const a=o?.apply(this,[i,...n]),r=this.inputs[i];if(!r.widget&&!(r.type in j)&&!(r.widget?.[U]?.()?.[0]instanceof Array))return a;const l=k.createNode("PrimitiveNode"),c=t.canvas.graph;if(!l||!c)return a;c?.add(l);const d=[this.pos[0]-l.size[0]-30,this.pos[1]];for(;c.getNodeOnPos(d[0],d[1],c.nodes);)d[1]+=k.NODE_TITLE_HEIGHT;return l.pos=d,l.connect(0,this,i),l.title=r.name,a}},registerCustomNodes(){k.registerNodeType("PrimitiveNode",Object.assign(ke,{title:"Primitive"})),ke.category="utils"}});window.comfyAPI=window.comfyAPI||{};window.comfyAPI.widgetInputs=window.comfyAPI.widgetInputs||{};window.comfyAPI.widgetInputs.PrimitiveNode=ke;window.comfyAPI.widgetInputs.getWidgetConfig=Oe;window.comfyAPI.widgetInputs.convertToInput=Kt;window.comfyAPI.widgetInputs.setWidgetConfig=Ne;window.comfyAPI.widgetInputs.mergeIfValid=se;const H={InUse:{Free:0,Registered:1,InWorkflow:2},isInUseGroupNode(s){const e=`${R}${L}${s}`;return g.graph.extra?.groupNodes?.[s]?g.graph.nodes.find(t=>t.type===e)?H.InUse.InWorkflow:H.InUse.Registered:H.InUse.Free},storeGroupNode(s,e){let t=g.graph.extra;t||(g.graph.extra=t={});let o=t.groupNodes;o||(t.groupNodes=o={}),o[s]=e}};class ze{static{u(this,"GroupNodeBuilder")}nodes;nodeData;constructor(e){this.nodes=e}async build(){const e=await this.getName();if(e)return this.sortNodes(),this.nodeData=this.getNodeData(),H.storeGroupNode(e,this.nodeData),{name:e,nodeData:this.nodeData}}async getName(){const e=await te().prompt({title:x("groupNode.create"),message:x("groupNode.enterName"),defaultValue:""});if(!e)return;switch(H.isInUseGroupNode(e)){case H.InUse.InWorkflow:M().addAlert("An in use group node with this name already exists embedded in this workflow, please remove any instances or use a new name.");return;case H.InUse.Registered:if(!confirm("A group node with this name already exists embedded in this workflow, are you sure you want to overwrite it?"))return;break}return e}sortNodes(){const e=g.graph.computeExecutionOrder(!1);this.nodes=this.nodes.map(t=>({index:e.indexOf(t),node:t})).sort((t,o)=>t.index-o.index||t.node.id-o.node.id).map(({node:t})=>t)}getNodeData(){const e=u(o=>{for(const i of o.links){const a=g.graph.getNodeById(i[4]).outputs[i[1]].type;i.push(a)}},"storeLinkTypes"),t=u(o=>{o.external=[];for(let i=0;i<this.nodes.length;i++){const n=this.nodes[i];if(n.outputs?.length)for(let a=0;a<n.outputs.length;a++){let r=!1;const l=n.outputs[a];let c=l.type;if(l.links?.length){for(const d of l.links){const h=g.graph.links[d];if(h&&(c==="*"&&(c=h.type),!g.canvas.selected_nodes[h.target_id])){r=!0;break}}r&&o.external.push([i,a,c])}}}},"storeExternalLinks");try{const o=xt(this.nodes,g.canvas?.graph),i=JSON.parse(o);return e(i),t(i),i}finally{}}}class X{static{u(this,"GroupNodeConfig")}name;nodeData;inputCount;oldToNewOutputMap;newToOldOutputMap;oldToNewInputMap;oldToNewWidgetMap;newToOldWidgetMap;primitiveDefs;widgetToPrimitive;primitiveToWidget;nodeInputs;outputVisibility;nodeDef;inputs;linksFrom;linksTo;externalFrom;constructor(e,t){this.name=e,this.nodeData=t,this.getLinks(),this.inputCount=0,this.oldToNewOutputMap={},this.newToOldOutputMap={},this.oldToNewInputMap={},this.oldToNewWidgetMap={},this.newToOldWidgetMap={},this.primitiveDefs={},this.widgetToPrimitive={},this.primitiveToWidget={},this.nodeInputs={},this.outputVisibility=[]}async registerType(e=R){this.nodeDef={output:[],output_name:[],output_is_list:[],output_is_hidden:[],name:e+L+this.name,display_name:this.name,category:"group nodes"+(L+e),input:{required:{}},description:`Group node combining ${this.nodeData.nodes.map(i=>i.type).join(", ")}`,python_module:"custom_nodes."+this.name,[W]:this},this.inputs=[];const t={},o={};for(let i=0;i<this.nodeData.nodes.length;i++){const n=this.nodeData.nodes[i];n.index=i,this.processNode(n,t,o)}for(const i of this.#e)i();this.#e=null,await g.registerNodeDef(`${R}${L}`+this.name,this.nodeDef),_t().addNodeDef(this.nodeDef)}getLinks(){this.linksFrom={},this.linksTo={},this.externalFrom={};for(const e of this.nodeData.links){const[t,o,i,n]=e;t!=null&&(this.linksFrom[t]||(this.linksFrom[t]={}),this.linksFrom[t][o]||(this.linksFrom[t][o]=[]),this.linksFrom[t][o].push(e),this.linksTo[i]||(this.linksTo[i]={}),this.linksTo[i][n]=e)}if(this.nodeData.external)for(const e of this.nodeData.external)this.externalFrom[e[0]]?this.externalFrom[e[0]][e[1]]=e[2]:this.externalFrom[e[0]]={[e[1]]:e[2]}}processNode(e,t,o){const i=this.getNodeDef(e);if(!i)return;const n={...i.input?.required,...i.input?.optional};this.inputs.push(this.processNodeInputs(e,t,n)),i.output?.length&&this.processNodeOutputs(e,o,i)}getNodeDef(e){const t=ie[e.type];if(t)return t;const o=this.linksFrom[e.index];if(e.type==="PrimitiveNode"){if(!o)return;let i=o[0][0][5];if(i==="COMBO"){const a=e.outputs[0].widget.name,r=this.nodeData.nodes[o[0][0][2]].type,l=ie[r];i=(l.input.required[a]??l.input.optional[a])[0]}return this.primitiveDefs[e.index]={input:{required:{value:[i,{}]}},output:[i],output_name:[],output_is_list:[]}}else if(e.type==="Reroute"){const i=this.linksTo[e.index];if(i&&o&&!this.externalFrom[e.index]?.[0])return null;let n={},a="*";if(o)for(const[,,r,l]of o[0]){const c=this.nodeData.nodes[r],d=c.inputs[l];if(a==="*"&&(a=d.type),d.widget){const h=ie[c.type],b=h.input.required[d.widget.name]??h.input.optional[d.widget.name],p=[b[0],n];n=se({widget:p},b,!1,null,p)?.customConfig??n}}else if(i){const[r,l]=i[0];a=this.nodeData.nodes[r].outputs[l].type}else{for(const r of this.nodeData.links)if(r[2]===e.index){a=r[5];break}if(a==="*"){const r=this.externalFrom[e.index]?.[0];r&&(a=r)}}return n.forceInput=!0,{input:{required:{[a]:[a,n]}},output:[a],output_name:[],output_is_list:[]}}console.warn("Skipping virtual node "+e.type+" when building group node "+this.name)}getInputConfig(e,t,o,i,n){const a=this.nodeData.config?.[e.index]?.input?.[t];let r=a?.name??e.inputs?.find(d=>d.name===t)?.label??t,l=r,c="";return(e.type==="PrimitiveNode"&&e.title||r in o)&&(c=`${e.title??e.type} `,l=r=`${c}${t}`,r in o&&(r=`${c}${o[r]} ${t}`)),o[l]=(o[l]??1)+1,(t==="seed"||t==="noise_seed")&&(n||(n={}),n.control_after_generate=`${c}control_after_generate`),i[0]==="IMAGEUPLOAD"&&(n||(n={}),n.widget=this.oldToNewWidgetMap[e.index]?.[i[1]?.widget??"image"]??"image"),n&&(i=[i[0],{...i[1],...n}]),{name:r,config:i,customConfig:a}}processWidgetInputs(e,t,o,i){const n=[],a=new Map,r=this.oldToNewWidgetMap[t.index]={};for(const l of o)if(kt().inputIsWidget(e[l])){const c=t.inputs?.findIndex(d=>d.name===l&&d.widget?.name===l);if(c>-1)a.set(c,l),r[l]=null;else{const{name:d,config:h}=this.getInputConfig(t,l,i,e[l]);this.nodeDef.input.required[d]=h,r[l]=d,this.newToOldWidgetMap[d]={node:t,inputName:l}}}else n.push(l);return{converted:a,slots:n}}checkPrimitiveConnection(e,t,o){if(this.nodeData.nodes[e[0]].type==="PrimitiveNode"){const[n,a,r,l]=e,c=this.primitiveDefs[n],d=o[t],h=c.input.required.value,p=se({widget:h},d,!1,null,h);h[1]=p?.customConfig??o[t][1]?{...o[t][1]}:{};let f=this.oldToNewWidgetMap[n].value;f=f.substr(0,f.length-6),h[1].control_after_generate=!0,h[1].control_prefix=f;let m=this.widgetToPrimitive[r];m||(m=this.widgetToPrimitive[r]={}),m[t]&&m[t].push(n),m[t]=n;let y=this.primitiveToWidget[n];y||(y=this.primitiveToWidget[n]=[]),y.push({nodeId:r,inputName:t})}}processInputSlots(e,t,o,i,n,a){this.nodeInputs[t.index]={};for(let r=0;r<o.length;r++){const l=o[r];if(i[r]){this.checkPrimitiveConnection(i[r],l,e);continue}const{name:c,config:d,customConfig:h}=this.getInputConfig(t,l,a,e[l]);this.nodeInputs[t.index][l]=c,h?.visible!==!1&&(this.nodeDef.input.required[c]=d,n[r]=this.inputCount++)}}processConvertedWidgets(e,t,o,i,n,a,r){const l=[...i.keys()].sort().map(c=>i.get(c));for(let c=0;c<l.length;c++){const d=l[c];if(n[o.length+c]){this.checkPrimitiveConnection(n[o.length+c],d,e);continue}const{name:h,config:b}=this.getInputConfig(t,d,r,e[d],{defaultInput:!0});this.nodeDef.input.required[h]=b,this.newToOldWidgetMap[h]={node:t,inputName:d},this.oldToNewWidgetMap[t.index]||(this.oldToNewWidgetMap[t.index]={}),this.oldToNewWidgetMap[t.index][d]=h,a[o.length+c]=this.inputCount++}}#e=[];processNodeInputs(e,t,o){const i=[],n=Object.keys(o);if(!n.length)return;const{converted:a,slots:r}=this.processWidgetInputs(o,e,n,t),l=this.linksTo[e.index]??{},c=this.oldToNewInputMap[e.index]={};return this.processInputSlots(o,e,r,l,c,t),this.#e.push(()=>this.processConvertedWidgets(o,e,r,a,l,c,t)),i}processNodeOutputs(e,t,o){const i=this.oldToNewOutputMap[e.index]={};for(let n=0;n<o.output.length;n++){const r=this.linksFrom[e.index]?.[n]&&!this.externalFrom[e.index]?.[n],l=this.nodeData.config?.[e.index]?.output?.[n],c=l?.visible??!r;if(this.outputVisibility.push(c),!c)continue;i[n]=this.nodeDef.output.length,this.newToOldOutputMap[this.nodeDef.output.length]={node:e,slot:n},this.nodeDef.output.push(o.output[n]),this.nodeDef.output_is_list.push(o.output_is_list[n]);let d=l?.name;if(!d){d=o.output_name?.[n]??o.output[n];const b=e.outputs.find(p=>p.name===d);b?.label&&(d=b.label)}let h=d;if(h in t){const b=`${e.title??e.type} `;h=`${b}${d}`,h in t&&(h=`${b}${e.index} ${d}`)}t[h]=1,this.nodeDef.output_name.push(h)}}static async registerFromWorkflow(e,t){for(const o in e){const i=e[o];let n=!1;for(const r of i.nodes)r.type in k.registered_node_types||(t.push({type:r.type,hint:` (In group node '${R}${L}${o}')`}),t.push({type:`${R}${L}`+o,action:{text:"Remove from workflow",callback:u(l=>{delete e[o],l.target.textContent="Removed",l.target.style.pointerEvents="none",l.target.style.opacity=.7},"callback")}}),n=!0);if(n)continue;await new X(o,i).registerType()}}}class G{static{u(this,"GroupNodeHandler")}node;groupData;innerNodes;constructor(e){this.node=e,this.groupData=e.constructor?.nodeData?.[W],this.node.setInnerNodes=p=>{this.innerNodes=p;for(let f=0;f<this.innerNodes.length;f++){const m=this.innerNodes[f];m.graph??=this.node.graph;for(const y of m.widgets??[])y.type==="converted-widget"&&(y.serializeValue=y.origSerializeValue);m.index=f,m.getInputNode=y=>{const w=this.groupData.oldToNewInputMap[m.index]?.[y];if(w!=null)return this.node.getInputNode(w);const C=this.groupData.linksTo[m.index]?.[y];if(!C)return null;const _=p[C[0]];return _.type==="PrimitiveNode"?null:_},m.getInputLink=y=>{const w=this.groupData.oldToNewInputMap[m.index]?.[y];if(w!=null){const _=this.node.inputs[w].link;let I=g.graph.links[_];return I={...I,target_id:m.id,target_slot:+y},I}let C=this.groupData.linksTo[m.index]?.[y];return C?(C={origin_id:p[C[0]].id,origin_slot:C[1],target_id:m.id,target_slot:+y},C):null}}},this.node.updateLink=p=>{p={...p};const f=this.groupData.newToOldOutputMap[p.origin_slot];let m=this.innerNodes[f.node.index],y;for(;m?.type==="Reroute";)y=m.getInputLink(0),m=m.getInputNode(0);return m?y&&G.isGroupNode(m)?m.updateLink(y):(p.origin_id=m.id,p.origin_slot=y?.origin_slot??f.slot,p):null},this.node.getInnerNodes=(p,f=[],m=[],y=new Set)=>{if(y.has(this.node))throw new Error("RecursionError: while flattening subgraph");y.add(this.node),this.innerNodes||this.node.setInnerNodes(this.groupData.nodeData.nodes.map((_,I)=>{const D=k.createNode(_.type);return D.configure(_),D.id=`${this.node.id}:${I}`,D.graph=this.node.graph,D})),this.updateInnerWidgets();const w=[...f,this.node.id],C=this.node.graph?.getNodeById(f.at(-1))??void 0;for(const _ of this.innerNodes){_.graph??=this.node.graph;const I=String(_.id);_.id=I.split(":").at(-1);const D=new $t(_,w,p,C);_.id=I,D.groupNodeHandler=this,m.push(D)}return m},this.node.recreate=async()=>{const p=this.node.id,f=this.node.size,m=this.node.convertToNodes(),y=k.createNode(this.node.type);y.id=p,y.setInnerNodes(m),y[W].populateWidgets(),g.graph.add(y),y.setSize([Math.max(y.size[0],f[0]),Math.max(y.size[1],f[1])]);const C=new ze(m).getNodeData();return y[W].groupData.nodeData.links=C.links,y[W].replaceNodes(m),y},this.node.convertToNodes=()=>{const p=u(()=>{const y={...this.groupData.nodeData};y.nodes=[...y.nodes];const w=this.node.getInnerNodes();let C=[];for(let P=0;P<y.nodes.length;P++){let K=w?.[P]?.id;K==null||isNaN(K)?K=void 0:C.push(K),y.nodes[P]={...y.nodes[P],id:K}}tt(JSON.stringify(y),g.canvas);const[_,I]=this.node.pos;let D,E;const A=C.length?C:Object.keys(g.canvas.selected_nodes),Y=[];for(let P=0;P<A.length;P++){const K=A[P],$=g.graph.getNodeById(K),Pe=w[P];if(Y.push($),(E==null||$.pos[0]<E)&&(E=$.pos[0]),(D==null||$.pos[1]<D)&&(D=$.pos[1]),!$.widgets)continue;const ge=this.groupData.oldToNewWidgetMap[Pe.index];if(ge){const at=Object.keys(ge);for(const Le of at){const Re=ge[Le];if(!Re)continue;const fe=this.node.widgets.findIndex(z=>z.name===Re);if(fe!==-1)if(Pe.type==="PrimitiveNode")for(let z=0;z<$.widgets.length;z++)$.widgets[z].value=this.node.widgets[fe+z].value;else{const z=this.node.widgets[fe],me=$.widgets.find(J=>J.name===Le);if(!me)continue;me.value=z.value;for(let J=0;J<z.linkedWidgets?.length;J++)me.linkedWidgets[J].value=z.linkedWidgets[J].value}}}}for(const P of Y)P.pos[0]-=E-_,P.pos[1]-=D-I;return{newNodes:Y,selectedIds:A}},"addInnerNodes"),f=u(y=>{for(const w in this.groupData.oldToNewInputMap){const C=y[w],_=g.graph.getNodeById(C),I=this.groupData.oldToNewInputMap[w];for(const D in I){const E=I[D];if(E==null)continue;const A=e.inputs[E];if(A.link==null)continue;const Y=g.graph.links[A.link];if(!Y)continue;g.graph.getNodeById(Y.origin_id).connect(Y.origin_slot,_,+D)}}},"reconnectInputs"),m=u(y=>{for(let w=0;w<e.outputs?.length;w++){const C=e.outputs[w];if(!C.links)continue;const _=[...C.links];for(const I of _){const D=this.groupData.newToOldOutputMap[w],E=g.graph.links[I],A=g.graph.getNodeById(E.target_id);g.graph.getNodeById(y[D.node.index]).connect(D.slot,A,E.target_slot)}}},"reconnectOutputs");g.canvas.emitBeforeChange();try{const{newNodes:y,selectedIds:w}=p();return f(w),m(w),g.graph.remove(this.node),y}finally{g.canvas.emitAfterChange()}};const t=this.node.getExtraMenuOptions;this.node.getExtraMenuOptions=function(p,f){t?.apply(this,arguments);let m=f.findIndex(y=>y?.content==="Outputs");m===-1?m=f.length:m++,f.splice(m,0,null,{content:"Convert to nodes",callback:u(()=>this.convertToNodes(),"callback")},{content:"Manage Group Node",callback:u(()=>Ie(this.type),"callback")})};const o=this.node.onDrawTitleBox;this.node.onDrawTitleBox=function(p,f){o?.apply(this,arguments);const m=p.fillStyle;p.beginPath(),p.rect(11,-f+11,2,2),p.rect(14,-f+11,2,2),p.rect(17,-f+11,2,2),p.rect(11,-f+14,2,2),p.rect(14,-f+14,2,2),p.rect(17,-f+14,2,2),p.rect(11,-f+17,2,2),p.rect(14,-f+17,2,2),p.rect(17,-f+17,2,2),p.fillStyle=this.boxcolor||k.NODE_DEFAULT_BOXCOLOR,p.fill(),p.fillStyle=m};const i=e.onDrawForeground,n=this.groupData.nodeData;e.onDrawForeground=function(p){i?.apply?.(this,arguments);const f=Nt().nodeProgressStates[this.id];if(f&&f.state==="running"&&this.runningInternalNodeId!==null){const m=n.nodes[this.runningInternalNodeId];if(!m)return;const y=`Running ${m.title||m.type} (${this.runningInternalNodeId}/${n.nodes.length})`;p.save(),p.font="12px sans-serif";const w=p.measureText(y);p.fillStyle=e.boxcolor||k.NODE_DEFAULT_BOXCOLOR,p.beginPath(),p.roundRect(0,-k.NODE_TITLE_HEIGHT-20,w.width+12,20,5),p.fill(),p.fillStyle="#fff",p.fillText(y,6,-k.NODE_TITLE_HEIGHT-6),p.restore()}};const a=this.node.onExecutionStart;this.node.onExecutionStart=function(){return this.resetExecution=!0,a?.apply(this,arguments)};const r=this,l=this.node.onNodeCreated;this.node.onNodeCreated=function(){if(!this.widgets)return;const p=r.groupData.nodeData.config;if(p)for(const f in p){const m=p[f]?.input;for(const y in m){if(m[y].visible!==!1)continue;const w=r.groupData.oldToNewWidgetMap[f][y],C=this.widgets.find(_=>_.name===w);C&&(C.type="hidden",C.computeSize=()=>[0,-4])}}return l?.apply(this,arguments)};function c(p,f,m){const y=u(({detail:w})=>{const C=f(w);if(!C||g.graph.getNodeById(C))return;const I=this.innerNodes?.findIndex(D=>D.id==C);I>-1&&(this.node.runningInternalNodeId=I,O.dispatchCustomEvent(p,m(w,`${this.node.id}`,this.node)))},"handler");return O.addEventListener(p,y),y}u(c,"handleEvent");const d=c.call(this,"executing",p=>p,(p,f)=>f),h=c.call(this,"executed",p=>p?.display_node||p?.node,(p,f,m)=>({...p,node:f,display_node:f,merge:!m.resetExecution})),b=e.onRemoved;this.node.onRemoved=function(){b?.apply(this,arguments),O.removeEventListener("executing",d),O.removeEventListener("executed",h)},this.node.refreshComboInNode=p=>{for(const f in this.groupData.newToOldWidgetMap){const m=this.node.widgets.find(y=>y.name===f);if(m?.type==="combo"){const y=this.groupData.newToOldWidgetMap[f],w=p[y.node.type],C=w?.input?.required?.[y.inputName]??w?.input?.optional?.[y.inputName];if(!C)continue;m.options.values=C[0],y.inputName!=="image"&&!m.options.values.includes(m.value)&&(m.value=m.options.values[0],m.callback(m.value))}}}}updateInnerWidgets(){for(const e in this.groupData.newToOldWidgetMap){const t=this.node.widgets.find(r=>r.name===e);if(!t)continue;const o=t.value,i=this.groupData.newToOldWidgetMap[e];let n=this.innerNodes[i.node.index];if(n.type==="PrimitiveNode"){n.primitiveValue=o;const r=this.groupData.primitiveToWidget[i.node.index];for(const l of r??[]){const d=this.innerNodes[l.nodeId].widgets.find(h=>h.name===l.inputName);d&&(d.value=o)}continue}else if(n.type==="Reroute"){const r=this.groupData.linksFrom[i.node.index];if(r)for(const[l,,c,d]of r[0]){const h=this.innerNodes[c],b=h.inputs[d];if(b.widget){const p=h.widgets?.find(f=>f.name===b.widget.name);p&&(p.value=o)}}}const a=n.widgets?.find(r=>r.name===i.inputName);a&&(a.value=o)}}populatePrimitive(e,t,o){const i=this.groupData.widgetToPrimitive[t]?.[o];if(i==null)return;const n=this.groupData.oldToNewWidgetMap[i].value,a=this.node.widgets.findIndex(r=>r.name===n);if(a>-1){const r=this.innerNodes[i];let l=r.widgets.length;l-1!==this.node.widgets[a].linkedWidgets?.length&&(l=1);for(let c=0;c<l;c++)this.node.widgets[a+c].value=r.widgets[c].value}return!0}populateReroute(e,t,o){if(e.type!=="Reroute")return;const i=this.groupData.linksFrom[t]?.[0]?.[0];if(!i)return;const[,,n,a]=i,r=this.groupData.nodeData.nodes[n],l=r.inputs;if(!l?.[a]?.widget)return;const d=l.length-(r.widgets_values?.length??0),h=r.widgets_values?.[a-d];if(h==null)return;const b=Object.values(o)[0],p=this.node.widgets.find(f=>f.name===b);p&&(p.value=h)}populateWidgets(){if(this.node.widgets)for(let e=0;e<this.groupData.nodeData.nodes.length;e++){const t=this.groupData.nodeData.nodes[e],o=this.groupData.oldToNewWidgetMap[e]??{},i=Object.keys(o);if(!t.widgets_values?.length){this.populateReroute(t,e,o);continue}let n=0;for(let a=0;a<i.length;a++){const r=i[a],l=o[r],c=this.node.widgets.findIndex(h=>h.name===l),d=this.node.widgets[c];if(this.populatePrimitive(t,e,r)||c===-1){const h=this.innerNodes[e].widgets?.find(b=>b.name===r);n+=h?.linkedWidgets?.length??0}if(c!==-1){d.value=t.widgets_values[a+n];for(let h=0;h<d.linkedWidgets?.length;h++)this.node.widgets[c+h+1].value=t.widgets_values[a+ ++n]}}}}replaceNodes(e){let t,o;for(let i=0;i<e.length;i++){const n=e[i];(o==null||n.pos[0]<o)&&(o=n.pos[0]),(t==null||n.pos[1]<t)&&(t=n.pos[1]),this.linkOutputs(n,i),g.graph.remove(n),n.id=`${this.node.id}:${i}`}this.linkInputs(),this.node.pos=[o,t]}linkOutputs(e,t){if(e.outputs)for(const o of e.outputs){if(!o.links)continue;const i=[...o.links];for(const n of i){const a=g.graph.links[n];if(!a)continue;const r=g.graph.getNodeById(a.target_id),l=this.groupData.oldToNewOutputMap[t]?.[a.origin_slot];l!=null&&this.node.connect(l,r,a.target_slot)}}}linkInputs(){for(const e of this.groupData.nodeData.links??[]){const[,t,o,i,n]=e,a=g.graph.getNodeById(n);a&&a.connect(t,this.node.id,this.groupData.oldToNewInputMap[o][i])}}static getGroupData(e){return(e.nodeData??e.constructor?.nodeData)?.[W]}static isGroupNode(e){return!!e.constructor?.nodeData?.[W]}static async fromNodes(e){const t=new ze(e),o=await t.build();if(!o)return;const{name:i,nodeData:n}=o;await new X(i,n).registerType();const r=k.createNode(`${R}${L}${i}`);return r.setInnerNodes(t.nodes),r[W].populateWidgets(),g.graph.add(r),r[W].replaceNodes(t.nodes),r}}const Zt=u(s=>{for(const e of s)typeof e.type=="string"&&e.type.startsWith("workflow/")&&(e.type=e.type.replace(/^workflow\//,`${R}${L}`))},"replaceLegacySeparators");async function ve(){const s=Object.values(g.canvas.selected_nodes??{});if(s.length===0)throw new Error("No nodes selected");if(s.length===1)throw new Error("Please select multiple nodes to convert to group node");for(const e of s){if(e instanceof It)throw new Error("Selected nodes contain a subgraph node");if(G.isGroupNode(e))throw new Error("Selected nodes contain a group node")}return await G.fromNodes(s)}u(ve,"convertSelectedNodesToGroupNode");const Ve=u(s=>s.length<2||!!s.find(e=>G.isGroupNode(e)),"convertDisabled");function Qt(){const s=Object.values(g.canvas.selected_nodes??{});for(const e of s)G.isGroupNode(e)&&e.convertToNodes?.()}u(Qt,"ungroupSelectedGroupNodes");function Ie(s){new st(g).show(s)}u(Ie,"manageGroupNodes");const eo="Comfy.GroupNode";let ie;const to={name:eo,commands:[{id:"Comfy.GroupNode.ConvertSelectedNodesToGroupNode",label:"Convert selected nodes to group node",icon:"pi pi-sitemap",versionAdded:"1.3.17",function:u(()=>ve(),"function")},{id:"Comfy.GroupNode.UngroupSelectedGroupNodes",label:"Ungroup selected group nodes",icon:"pi pi-sitemap",versionAdded:"1.3.17",function:u(()=>Qt(),"function")},{id:"Comfy.GroupNode.ManageGroupNodes",label:"Manage group nodes",icon:"pi pi-cog",versionAdded:"1.3.17",function:u((...s)=>Ie(s[0]),"function")}],keybindings:[{commandId:"Comfy.GroupNode.ConvertSelectedNodesToGroupNode",combo:{alt:!0,key:"g"}},{commandId:"Comfy.GroupNode.UngroupSelectedGroupNodes",combo:{alt:!0,shift:!0,key:"G"}}],getCanvasMenuItems(s){const e=[],t=Object.values(s.selected_nodes??{}),o=!Ve(t);e.push({content:"Convert to Group Node (Deprecated)",disabled:!o,callback:u(()=>ve(),"callback")});const i=s.graph?.extra?.groupNodes,n=!i||!Object.keys(i).length;return e.push({content:"Manage Group Nodes",disabled:n,callback:u(()=>Ie(),"callback")}),e},getNodeMenuItems(s){if(G.isGroupNode(s))return[];const e=Object.values(g.canvas.selected_nodes??{});return[{content:"Convert to Group Node (Deprecated)",disabled:!!Ve(e),callback:u(()=>ve(),"callback")}]},async beforeConfigureGraph(s,e){const t=s?.extra?.groupNodes;t&&(Zt(s.nodes),await X.registerFromWorkflow(t,e))},addCustomNodeDefs(s){ie=s},nodeCreated(s){G.isGroupNode(s)&&(s[W]=new G(s),s.title&&s[W]?.groupData?.nodeData&&H.storeGroupNode(s.title,s[W].groupData.nodeData))},async refreshComboInNodes(s){Object.assign(ie,s);const e=g.graph.extra?.groupNodes;e&&await X.registerFromWorkflow(e,{})}};g.registerExtension(to);window.comfyAPI=window.comfyAPI||{};window.comfyAPI.groupNode=window.comfyAPI.groupNode||{};window.comfyAPI.groupNode.GroupNodeConfig=X;window.comfyAPI.groupNode.GroupNodeHandler=G;function F(s,e){s.mode=e,s.graph?.change()}u(F,"setNodeMode");function $e(s,e){const t=Q().get("Comfy.GroupSelectedNodes.Padding");s.resizeTo([...s.children,...e],t)}u($e,"addNodesToGroup");const oo={name:"Comfy.GroupOptions",getCanvasMenuItems(s){const e=[],t=s.graph.getGroupOnPos(s.graph_mouse[0],s.graph_mouse[1]);if(!t)return s.selectedItems.size>0&&e.push({content:"Add Group For Selected Nodes",callback:u(()=>{const n=new Dt;$e(n,s.selectedItems),s.graph.add(n),s.graph.change(),n.recomputeInsideNodes()},"callback")}),e;t.recomputeInsideNodes();const o=t.nodes;if(e.push({content:"Add Selected Nodes To Group",disabled:!s.selectedItems?.size,callback:u(()=>{$e(t,s.selectedItems),s.graph.change()},"callback")}),o.length===0)return e;e.push(null);let i=!0;for(let n=1;n<o.length;n++)if(o[n].mode!==o[0].mode){i=!1;break}if(e.push({content:"Fit Group To Nodes",callback:u(()=>{t.recomputeInsideNodes();const n=Q().get("Comfy.GroupSelectedNodes.Padding");t.resizeTo(t.children,n),s.graph.change()},"callback")}),e.push({content:"Select Nodes",callback:u(()=>{s.selectNodes(o),s.graph.change(),s.canvas.focus()},"callback")}),i)switch(o[0].mode){case 0:e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const a of o)F(a,2)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const a of o)F(a,4)},"callback")});break;case 2:e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const a of o)F(a,0)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const a of o)F(a,4)},"callback")});break;case 4:e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const a of o)F(a,0)},"callback")}),e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const a of o)F(a,2)},"callback")});break;default:e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const a of o)F(a,0)},"callback")}),e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const a of o)F(a,2)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const a of o)F(a,4)},"callback")});break}else e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const n of o)F(n,0)},"callback")}),e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const n of o)F(n,2)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const n of o)F(n,4)},"callback")});return e}};g.registerExtension(oo);const io=[{label:"GLB",value:"glb"},{label:"OBJ",value:"obj"},{label:"STL",value:"stl"}];function he(s){return[null,{content:"Save",has_submenu:!0,callback:u((e,t,o,i)=>{const n=io.map(a=>({content:a.label,callback:u(()=>{(async()=>{try{await s.exportModel(a.value),M().add({severity:"success",summary:x("toastMessages.exportSuccess",{format:a.label})})}catch(r){console.error("Export failed:",r),M().addAlert(x("toastMessages.failedToExportModel",{format:a.label}))}})()},"callback")}));new k.ContextMenu(n,{event:o,parentMenu:i})},"callback")}]}u(he,"createExportMenuItems");window.comfyAPI=window.comfyAPI||{};window.comfyAPI.exportMenuHelper=window.comfyAPI.exportMenuHelper||{};window.comfyAPI.exportMenuHelper.createExportMenuItems=he;class Ae{static{u(this,"Load3DConfiguration")}constructor(e,t){this.load3d=e,this.properties=t}configureForSaveMesh(e,t){this.setupModelHandlingForSaveMesh(t,e),this.setupDefaultProperties()}configure(e){this.setupModelHandling(e.modelWidget,e.loadFolder,e.cameraState),this.setupTargetSize(e.width,e.height),this.setupDefaultProperties(e.bgImagePath)}setupTargetSize(e,t){e&&t&&(this.load3d.setTargetSize(e.value,t.value),e.callback=o=>{this.load3d.setTargetSize(o,t.value)},t.callback=o=>{this.load3d.setTargetSize(e.value,o)})}setupModelHandlingForSaveMesh(e,t){const o=this.createModelUpdateHandler(t);e&&o(e)}setupModelHandling(e,t,o){const i=this.createModelUpdateHandler(t,o);e.value&&i(e.value);const n=e.callback;let a=e.value;Object.defineProperty(e,"value",{get(){return a},set(r){a=r,e.callback&&r!==void 0&&r!==""&&e.callback(r)},enumerable:!0,configurable:!0}),e.callback=r=>{i(r),n&&n(r)}}setupDefaultProperties(e){const t=this.loadSceneConfig();this.applySceneConfig(t,e);const o=this.loadCameraConfig();this.applyCameraConfig(o);const i=this.loadLightConfig();this.applyLightConfig(i)}loadSceneConfig(){return this.properties&&"Scene Config"in this.properties?this.properties["Scene Config"]:{showGrid:Q().get("Comfy.Load3D.ShowGrid"),backgroundColor:"#"+Q().get("Comfy.Load3D.BackgroundColor"),backgroundImage:""}}loadCameraConfig(){return this.properties&&"Camera Config"in this.properties?this.properties["Camera Config"]:{cameraType:Q().get("Comfy.Load3D.CameraType"),fov:35}}loadLightConfig(){return this.properties&&"Light Config"in this.properties?this.properties["Light Config"]:{intensity:Q().get("Comfy.Load3D.LightIntensity")}}loadModelConfig(){return this.properties&&"Model Config"in this.properties?this.properties["Model Config"]:{upDirection:"original",materialMode:"original"}}applySceneConfig(e,t){if(this.load3d.toggleGrid(e.showGrid),this.load3d.setBackgroundColor(e.backgroundColor),e.backgroundImage){if(t&&t!=e.backgroundImage)return;this.load3d.setBackgroundImage(e.backgroundImage),e.backgroundRenderMode&&this.load3d.setBackgroundRenderMode(e.backgroundRenderMode)}}applyCameraConfig(e){this.load3d.toggleCamera(e.cameraType),this.load3d.setFOV(e.fov),e.state&&this.load3d.setCameraState(e.state)}applyLightConfig(e){this.load3d.setLightIntensity(e.intensity)}applyModelConfig(e){this.load3d.setUpDirection(e.upDirection),this.load3d.setMaterialMode(e.materialMode)}createModelUpdateHandler(e,t){let o=!0;return async i=>{if(!i)return;const n=i;this.setResourceFolder(n);const a=O.apiURL(V.getResourceURL(...V.splitFilePath(n),e));await this.load3d.loadModel(a,n);const r=this.loadModelConfig();if(this.applyModelConfig(r),o&&t){try{this.load3d.setCameraState(t)}catch(l){console.warn("Failed to restore camera state:",l)}o=!1}}}setResourceFolder(e){const t=e.split("/").filter(n=>n.trim());if(t.length<=2)return;const i=t.slice(1,-1).join("/");i&&this.properties&&(this.properties["Resource Folder"]=i)}}const no={name:"image",type:"Load3D",isPreview:!1},je={name:"image",type:"Preview3D",isPreview:!0};async function so(s,e){if(!s?.length)return;const t=e.widgets?.find(o=>o.name==="model_file");try{const o=e.properties["Resource Folder"]||"",i=o.trim()?`3d/${o.trim()}`:"3d",n=await V.uploadFile(s[0],i);if(!n){M().addAlert(x("toastMessages.fileUploadFailed"));return}const a=O.apiURL(V.getResourceURL(...V.splitFilePath(n),"input"));ne(e).waitForLoad3d(r=>{try{r.loadModel(a)}catch{M().addAlert(x("toastMessages.failedToLoadModel"))}}),n&&t&&(t.options?.values?.includes(n)||t.options?.values?.push(n),t.value=n)}catch(o){console.error("Model upload failed:",o),M().addAlert(x("toastMessages.fileUploadFailed"))}}u(so,"handleModelUpload");async function ao(s,e){if(s?.length)try{const t=e.properties["Resource Folder"]||"",o=t.trim()?`3d/${t.trim()}`:"3d";await V.uploadMultipleFiles(s,o)}catch(t){console.error("Extra resources upload failed:",t),M().addAlert(x("toastMessages.extraResourcesUploadFailed"))}}u(ao,"handleResourcesUpload");function Ye(s,e=!1){const t=document.createElement("input");return t.type="file",t.accept=s,t.multiple=e,t.style.display="none",t}u(Ye,"createFileInput");ae().registerExtension({name:"Comfy.Load3D",settings:[{id:"Comfy.Load3D.ShowGrid",category:["3D","Scene","Initial Grid Visibility"],name:"Initial Grid Visibility",tooltip:"Controls whether the grid is visible by default when a new 3D widget is created. This default can still be toggled individually for each widget after creation.",type:"boolean",defaultValue:!0,experimental:!0},{id:"Comfy.Load3D.BackgroundColor",category:["3D","Scene","Initial Background Color"],name:"Initial Background Color",tooltip:"Controls the default background color of the 3D scene. This setting determines the background appearance when a new 3D widget is created, but can be adjusted individually for each widget after creation.",type:"color",defaultValue:"282828",experimental:!0},{id:"Comfy.Load3D.CameraType",category:["3D","Camera","Initial Camera Type"],name:"Initial Camera Type",tooltip:"Controls whether the camera is perspective or orthographic by default when a new 3D widget is created. This default can still be toggled individually for each widget after creation.",type:"combo",options:["perspective","orthographic"],defaultValue:"perspective",experimental:!0},{id:"Comfy.Load3D.LightIntensity",category:["3D","Light","Initial Light Intensity"],name:"Initial Light Intensity",tooltip:"Sets the default brightness level of lighting in the 3D scene. This value determines how intensely lights illuminate objects when a new 3D widget is created, but can be adjusted individually for each widget after creation.",type:"number",defaultValue:3,experimental:!0},{id:"Comfy.Load3D.LightIntensityMaximum",category:["3D","Light","Light Intensity Maximum"],name:"Light Intensity Maximum",tooltip:"Sets the maximum allowable light intensity value for 3D scenes. This defines the upper brightness limit that can be set when adjusting lighting in any 3D widget.",type:"number",defaultValue:10,experimental:!0},{id:"Comfy.Load3D.LightIntensityMinimum",category:["3D","Light","Light Intensity Minimum"],name:"Light Intensity Minimum",tooltip:"Sets the minimum allowable light intensity value for 3D scenes. This defines the lower brightness limit that can be set when adjusting lighting in any 3D widget.",type:"number",defaultValue:1,experimental:!0},{id:"Comfy.Load3D.LightAdjustmentIncrement",category:["3D","Light","Light Adjustment Increment"],name:"Light Adjustment Increment",tooltip:"Controls the increment size when adjusting light intensity in 3D scenes. A smaller step value allows for finer control over lighting adjustments, while a larger value results in more noticeable changes per adjustment.",type:"slider",attrs:{min:.1,max:1,step:.1},defaultValue:.5,experimental:!0},{id:"Comfy.Load3D.3DViewerEnable",category:["3D","3DViewer","Enable"],name:"Enable 3D Viewer (Beta)",tooltip:"Enables the 3D Viewer (Beta) for selected nodes. This feature allows you to visualize and interact with 3D models directly within the full size 3d viewer.",type:"boolean",defaultValue:!1,experimental:!0}],commands:[{id:"Comfy.3DViewer.Open3DViewer",icon:"pi pi-pencil",label:"Open 3D Viewer (Beta) for Selected Node",function:u(()=>{const s=g.canvas.selected_nodes;if(!s||Object.keys(s).length!==1)return;const e=s[Object.keys(s)[0]];if(!Tt(e))return;N.copyToClipspace(e),N.clipspace_return_node=e;const t={node:e};ot().showDialog({key:"global-load3d-viewer",title:x("load3d.viewer.title"),component:Et,props:t,dialogComponentProps:{style:"width: 80vw; height: 80vh;",maximizable:!0,onClose:u(async()=>{await de().handleViewerClose(t.node)},"onClose")}})},"function")}],getCustomWidgets(){return{LOAD_3D(s){const e=Ye(".gltf,.glb,.obj,.fbx,.stl",!1);s.properties["Resource Folder"]="",e.onchange=async()=>{await so(e.files,s)},s.addWidget("button","upload 3d model","upload3dmodel",()=>{e.click()});const t=Ye("*",!0);t.onchange=async()=>{await ao(t.files,s),t.value=""},s.addWidget("button","upload extra resources","uploadExtraResources",()=>{t.click()}),s.addWidget("button","clear","clear",()=>{ne(s).waitForLoad3d(n=>{n.clearModel()});const i=s.widgets?.find(n=>n.name==="model_file");i&&(i.value="")});const o=new De({node:s,name:"image",component:Se,inputSpec:no,options:{}});return o.type="load3D",Te(s,o),{widget:o}}}},getNodeMenuItems(s){if(s.constructor.comfyClass!=="Load3D")return[];const e=de().getLoad3d(s);return e?he(e):[]},async nodeCreated(s){if(s.constructor.comfyClass!=="Load3D")return;const[e,t]=s.size;s.setSize([Math.max(e,300),Math.max(t,600)]),await Ee(),ne(s).waitForLoad3d(o=>{const n=s.properties["Camera Config"]?.state,a=new Ae(o,s.properties),r=s.widgets?.find(h=>h.name==="model_file"),l=s.widgets?.find(h=>h.name==="width"),c=s.widgets?.find(h=>h.name==="height"),d=s.widgets?.find(h=>h.name==="image");if(r&&l&&c&&d){const h={loadFolder:"input",modelWidget:r,cameraState:n,width:l,height:c};a.configure(h),d.serializeValue=async()=>{const b=St.get(s);if(!b)return console.error("No load3d instance found for node"),null;const p=s.properties["Camera Config"]||{cameraType:b.getCurrentCameraType(),fov:b.cameraManager.perspectiveCamera.fov};p.state=b.getCameraState(),s.properties["Camera Config"]=p,b.stopRecording();const{scene:f,mask:m,normal:y}=await b.captureScene(l.value,c.value),[w,C,_]=await Promise.all([V.uploadTempImage(f,"scene"),V.uploadTempImage(m,"scene_mask"),V.uploadTempImage(y,"scene_normal")]);b.handleResize();const I={image:`threed/${w.name} [temp]`,mask:`threed/${C.name} [temp]`,normal:`threed/${_.name} [temp]`,camera_info:s.properties["Camera Config"]?.state||null,recording:""},D=b.getRecordingData();if(D){const[E]=await Promise.all([V.uploadTempImage(D,"recording","mp4")]);I.recording=`threed/${E.name} [temp]`}return I}}})}});ae().registerExtension({name:"Comfy.Preview3D",async beforeRegisterNodeDef(s,e){e.name==="Preview3D"&&(e.input.required.image=["PREVIEW_3D"])},getNodeMenuItems(s){if(s.constructor.comfyClass!=="Preview3D")return[];const e=de().getLoad3d(s);return e?he(e):[]},getCustomWidgets(){return{PREVIEW_3D(s){const e=new De({node:s,name:je.name,component:Se,inputSpec:je,options:{}});return e.type="load3D",Te(s,e),{widget:e}}}},async nodeCreated(s){if(s.constructor.comfyClass!=="Preview3D")return;const[e,t]=s.size;s.setSize([Math.max(e,400),Math.max(t,550)]),await Ee();const o=s.onExecuted;ne(s).waitForLoad3d(i=>{const n=new Ae(i,s.properties),a=s.widgets?.find(r=>r.name==="model_file");if(a){const r=s.properties["Last Time Model File"];if(r){a.value=r;const c=s.properties["Camera Config"]?.state,d={loadFolder:"output",modelWidget:a,cameraState:c};n.configure(d)}s.onExecuted=function(l){o?.apply(this,arguments);let c=l.result[0];if(!c){const p=x("toastMessages.unableToGetModelFilePath");console.error(p),M().addAlert(p)}let d=l.result[1],h=l.result[2];a.value=c.replaceAll("\\","/"),s.properties["Last Time Model File"]=a.value;const b={loadFolder:"output",modelWidget:a,cameraState:d,bgImagePath:h};n.configure(b),h&&i.setBackgroundImage(h)}}})}});function ro(s){const e=s.split(";base64,"),t=e[0].split(":")[1],o=atob(e[1]),i=new ArrayBuffer(o.length),n=new Uint8Array(i);for(let a=0;a<o.length;a++)n[a]=o.charCodeAt(a);return new Blob([i],{type:t})}u(ro,"dataURLToBlob");function lo(s){return new Promise(e=>{const t=new Image;t.onload=function(){e(t)},t.src=s})}u(lo,"loadImage");async function co(s,e){await O.fetchApi("/upload/mask",{method:"POST",body:e}).catch(t=>{console.error("Error:",t)}),N.clipspace.imgs[N.clipspace.selectedIndex]=new Image,N.clipspace.imgs[N.clipspace.selectedIndex].src=O.apiURL("/view?"+new URLSearchParams(s).toString()+g.getPreviewFormatParam()+g.getRandParam()),N.clipspace.images&&(N.clipspace.images[N.clipspace.selectedIndex]=s),S.invalidatePreview()}u(co,"uploadMask");function uo(s,e,t,o){t.drawImage(s,0,0,e.width,e.height);const i=t.getImageData(0,0,e.width,e.height);for(let n=0;n<i.data.length;n+=4)i.data[n+3]==255?i.data[n+3]=0:i.data[n+3]=255,i.data[n]=o.r,i.data[n+1]=o.g,i.data[n+2]=o.b;t.globalCompositeOperation="source-over",t.putImageData(i,0,0)}u(uo,"prepare_mask");class T extends xe{static{u(this,"MaskEditorDialogOld")}static instance=null;static mousedown_x=null;static mousedown_y=null;brush;maskCtx;maskCanvas;brush_size_slider;brush_opacity_slider;colorButton;saveButton;zoom_ratio;pan_x;pan_y;imgCanvas;last_display_style;is_visible;image;handler_registered;brush_slider_input;cursorX;cursorY;mousedown_pan_x;mousedown_pan_y;last_pressure;pointer_type;brush_pointer_type_select;static getInstance(){return T.instance||(T.instance=new T),T.instance}is_layout_created=!1;constructor(){super(),this.element=v("div.comfy-modal",{parent:document.body},[v("div.comfy-modal-content",[...this.createButtons()])])}createButtons(){return[]}createButton(e,t){var o=document.createElement("button");return o.style.pointerEvents="auto",o.innerText=e,o.addEventListener("click",t),o}createLeftButton(e,t){var o=this.createButton(e,t);return o.style.cssFloat="left",o.style.marginRight="4px",o}createRightButton(e,t){var o=this.createButton(e,t);return o.style.cssFloat="right",o.style.marginLeft="4px",o}createLeftSlider(e,t,o){const i=document.createElement("div");i.id="maskeditor-slider",i.style.cssFloat="left",i.style.fontFamily="sans-serif",i.style.marginRight="4px",i.style.color="var(--input-text)",i.style.backgroundColor="var(--comfy-input-bg)",i.style.borderRadius="8px",i.style.borderColor="var(--border-color)",i.style.borderStyle="solid",i.style.fontSize="15px",i.style.height="25px",i.style.padding="1px 6px",i.style.display="flex",i.style.position="relative",i.style.top="2px",i.style.pointerEvents="auto",e.brush_slider_input=document.createElement("input"),e.brush_slider_input.setAttribute("type","range"),e.brush_slider_input.setAttribute("min","1"),e.brush_slider_input.setAttribute("max","100"),e.brush_slider_input.setAttribute("value","10");const n=document.createElement("label");return n.textContent=t,i.appendChild(n),i.appendChild(e.brush_slider_input),e.brush_slider_input.addEventListener("change",o),i}createOpacitySlider(e,t,o){const i=document.createElement("div");i.id="maskeditor-opacity-slider",i.style.cssFloat="left",i.style.fontFamily="sans-serif",i.style.marginRight="4px",i.style.color="var(--input-text)",i.style.backgroundColor="var(--comfy-input-bg)",i.style.borderRadius="8px",i.style.borderColor="var(--border-color)",i.style.borderStyle="solid",i.style.fontSize="15px",i.style.height="25px",i.style.padding="1px 6px",i.style.display="flex",i.style.position="relative",i.style.top="2px",i.style.pointerEvents="auto",e.opacity_slider_input=document.createElement("input"),e.opacity_slider_input.setAttribute("type","range"),e.opacity_slider_input.setAttribute("min","0.1"),e.opacity_slider_input.setAttribute("max","1.0"),e.opacity_slider_input.setAttribute("step","0.01"),e.opacity_slider_input.setAttribute("value","0.7");const n=document.createElement("label");return n.textContent=t,i.appendChild(n),i.appendChild(e.opacity_slider_input),e.opacity_slider_input.addEventListener("input",o),i}createPointerTypeSelect(e){const t=document.createElement("div");t.id="maskeditor-pointer-type",t.style.cssFloat="left",t.style.fontFamily="sans-serif",t.style.marginRight="4px",t.style.color="var(--input-text)",t.style.backgroundColor="var(--comfy-input-bg)",t.style.borderRadius="8px",t.style.borderColor="var(--border-color)",t.style.borderStyle="solid",t.style.fontSize="15px",t.style.height="25px",t.style.padding="1px 6px",t.style.display="flex",t.style.position="relative",t.style.top="2px",t.style.pointerEvents="auto";const o=document.createElement("label");o.textContent="Pointer Type:";const i=document.createElement("select");i.style.borderRadius="0",i.style.borderColor="transparent",i.style.borderStyle="unset",i.style.fontSize="0.9em";const n=document.createElement("option");n.value="arc",n.text="Circle",n.selected=!0;const a=document.createElement("option");return a.value="rect",a.text="Square",i.appendChild(n),i.appendChild(a),i.addEventListener("change",r=>{const l=r.target;e.pointer_type=l.value,this.setBrushBorderRadius(e)}),t.appendChild(o),t.appendChild(i),t}setBrushBorderRadius(e){e.pointer_type==="rect"?(this.brush.style.borderRadius="0%",this.brush.style.MozBorderRadius="0%",this.brush.style.WebkitBorderRadius="0%"):(this.brush.style.borderRadius="50%",this.brush.style.MozBorderRadius="50%",this.brush.style.WebkitBorderRadius="50%")}setlayout(e,t){const o=this;o.pointer_type="arc";var i=document.createElement("div");i.style.position="absolute",i.style.bottom="0px",i.style.left="20px",i.style.right="20px",i.style.height="50px",i.style.pointerEvents="none";var n=document.createElement("div");n.id="brush",n.style.backgroundColor="transparent",n.style.outline="1px dashed black",n.style.boxShadow="0 0 0 1px white",n.style.position="absolute",n.style.zIndex="8889",n.style.pointerEvents="none",this.brush=n,this.setBrushBorderRadius(o),this.element.appendChild(e),this.element.appendChild(t),this.element.appendChild(i),document.body.appendChild(n);var a=this.createLeftButton("Clear",()=>{o.maskCtx.clearRect(0,0,o.maskCanvas.width,o.maskCanvas.height)});this.brush_size_slider=this.createLeftSlider(o,"Thickness",c=>{o.brush_size=c.target.value,o.updateBrushPreview(o)}),this.brush_opacity_slider=this.createOpacitySlider(o,"Opacity",c=>{o.brush_opacity=c.target.value,o.brush_color_mode!=="negative"&&(o.maskCanvas.style.opacity=o.brush_opacity.toString())}),this.brush_pointer_type_select=this.createPointerTypeSelect(o),this.colorButton=this.createLeftButton(this.getColorButtonText(),()=>{o.brush_color_mode==="black"?o.brush_color_mode="white":o.brush_color_mode==="white"?o.brush_color_mode="negative":o.brush_color_mode="black",o.updateWhenBrushColorModeChanged()});var r=this.createRightButton("Cancel",()=>{document.removeEventListener("keydown",T.handleKeyDown),o.close()});this.saveButton=this.createRightButton("Save",()=>{document.removeEventListener("keydown",T.handleKeyDown),o.save()}),this.element.appendChild(e),this.element.appendChild(t),this.element.appendChild(i),i.appendChild(a),i.appendChild(this.saveButton),i.appendChild(r),i.appendChild(this.brush_size_slider),i.appendChild(this.brush_opacity_slider),i.appendChild(this.brush_pointer_type_select),i.appendChild(this.colorButton),e.style.position="absolute",t.style.position="absolute",e.style.top="200",e.style.left="0",t.style.top=e.style.top,t.style.left=e.style.left;const l=this.getMaskCanvasStyle();t.style.mixBlendMode=l.mixBlendMode,t.style.opacity=l.opacity.toString()}async show(){if(this.zoom_ratio=1,this.pan_x=0,this.pan_y=0,!this.is_layout_created){const e=document.createElement("canvas"),t=document.createElement("canvas");e.id="imageCanvas",t.id="maskCanvas",this.setlayout(e,t),this.imgCanvas=e,this.maskCanvas=t,this.maskCtx=t.getContext("2d",{willReadFrequently:!0}),this.setEventHandler(t),this.is_layout_created=!0;const o=this,i=new MutationObserver(function(a){a.forEach(function(r){r.type==="attributes"&&r.attributeName==="style"&&(o.last_display_style&&o.last_display_style!="none"&&o.element.style.display=="none"&&(o.brush.style.display="none",N.onClipspaceEditorClosed()),o.last_display_style=o.element.style.display)})}),n={attributes:!0};i.observe(this.element,n)}document.addEventListener("keydown",T.handleKeyDown),N.clipspace_return_node?this.saveButton.innerText="Save to node":this.saveButton.innerText="Save",this.saveButton.disabled=!1,this.element.style.display="block",this.element.style.width="85%",this.element.style.margin="0 7.5%",this.element.style.height="100vh",this.element.style.top="50%",this.element.style.left="42%",this.element.style.zIndex="8888",await this.setImages(this.imgCanvas),this.is_visible=!0}isOpened(){return this.element.style.display=="block"}invalidateCanvas(e,t){this.imgCanvas.width=e.width,this.imgCanvas.height=e.height,this.maskCanvas.width=e.width,this.maskCanvas.height=e.height;let o=this.imgCanvas.getContext("2d",{willReadFrequently:!0}),i=this.maskCanvas.getContext("2d",{willReadFrequently:!0});o.drawImage(e,0,0,e.width,e.height),uo(t,this.maskCanvas,i,this.getMaskColor())}async setImages(e){let t=this;const o=e.getContext("2d",{willReadFrequently:!0}),i=this.maskCtx,n=this.maskCanvas;o.clearRect(0,0,this.imgCanvas.width,this.imgCanvas.height),i.clearRect(0,0,this.maskCanvas.width,this.maskCanvas.height);const a=new URL(N.clipspace.imgs[N.clipspace.selectedIndex].src);a.searchParams.delete("channel"),a.searchParams.delete("preview"),a.searchParams.set("channel","a");let r=await lo(a);const l=new URL(N.clipspace.imgs[N.clipspace.selectedIndex].src);l.searchParams.delete("channel"),l.searchParams.set("channel","rgb"),this.image=new Image,this.image.onload=function(){n.width=t.image.width,n.height=t.image.height,t.invalidateCanvas(t.image,r),t.initializeCanvasPanZoom()},this.image.src=l.toString()}initializeCanvasPanZoom(){let e=this.image.width,t=this.image.height,o=this.element.clientWidth,i=this.element.clientHeight;this.image.width>o&&(e=o,t=e/this.image.width*this.image.height),t>i&&(t=i,e=t/this.image.height*this.image.width),this.zoom_ratio=e/this.image.width;const n=(o-e)/2,a=(i-t)/2;this.pan_x=n,this.pan_y=a,this.invalidatePanZoom()}invalidatePanZoom(){let e=this.image.width*this.zoom_ratio,t=this.image.height*this.zoom_ratio;this.pan_x+e<10&&(this.pan_x=10-e),this.pan_y+t<10&&(this.pan_y=10-t);let o=`${e}px`,i=`${t}px`,n=`${this.pan_x}px`,a=`${this.pan_y}px`;this.maskCanvas.style.width=o,this.maskCanvas.style.height=i,this.maskCanvas.style.left=n,this.maskCanvas.style.top=a,this.imgCanvas.style.width=o,this.imgCanvas.style.height=i,this.imgCanvas.style.left=n,this.imgCanvas.style.top=a}setEventHandler(e){const t=this;this.handler_registered||(e.addEventListener("contextmenu",o=>{o.preventDefault()}),this.element.addEventListener("wheel",o=>this.handleWheelEvent(t,o)),this.element.addEventListener("pointermove",o=>this.pointMoveEvent(t,o)),this.element.addEventListener("touchmove",o=>this.pointMoveEvent(t,o)),this.element.addEventListener("dragstart",o=>{o.ctrlKey&&o.preventDefault()}),e.addEventListener("pointerdown",o=>this.handlePointerDown(t,o)),e.addEventListener("pointermove",o=>this.draw_move(t,o)),e.addEventListener("touchmove",o=>this.draw_move(t,o)),e.addEventListener("pointerover",()=>{this.brush.style.display="block"}),e.addEventListener("pointerleave",()=>{this.brush.style.display="none"}),document.addEventListener("pointerup",T.handlePointerUp),this.handler_registered=!0)}getMaskCanvasStyle(){return this.brush_color_mode==="negative"?{mixBlendMode:"difference",opacity:"1"}:{mixBlendMode:"initial",opacity:this.brush_opacity}}getMaskColor(){return this.brush_color_mode==="black"?{r:0,g:0,b:0}:this.brush_color_mode==="white"?{r:255,g:255,b:255}:this.brush_color_mode==="negative"?{r:255,g:255,b:255}:{r:0,g:0,b:0}}getMaskFillStyle(){const e=this.getMaskColor();return"rgb("+e.r+","+e.g+","+e.b+")"}getColorButtonText(){let e="unknown";return this.brush_color_mode==="black"?e="black":this.brush_color_mode==="white"?e="white":this.brush_color_mode==="negative"&&(e="negative"),"Color: "+e}updateWhenBrushColorModeChanged(){this.colorButton.innerText=this.getColorButtonText();const e=this.getMaskCanvasStyle();this.maskCanvas.style.mixBlendMode=e.mixBlendMode,this.maskCanvas.style.opacity=e.opacity.toString();const t=this.getMaskColor(),o=this.maskCtx.getImageData(0,0,this.maskCanvas.width,this.maskCanvas.height);for(let i=0;i<o.data.length;i+=4)o.data[i]=t.r,o.data[i+1]=t.g,o.data[i+2]=t.b;this.maskCtx.putImageData(o,0,0)}brush_opacity=.7;brush_size=10;brush_color_mode="black";drawing_mode=!1;lastx=-1;lasty=-1;lasttime=0;static handleKeyDown(e){const t=T.instance;e.key==="]"?(t.brush_size=Math.min(t.brush_size+2,100),t.brush_slider_input.value=t.brush_size):e.key==="["?(t.brush_size=Math.max(t.brush_size-2,1),t.brush_slider_input.value=t.brush_size):e.key==="Enter"&&t.save(),t.updateBrushPreview(t)}static handlePointerUp(e){e.preventDefault(),this.mousedown_x=null,this.mousedown_y=null,T.instance.drawing_mode=!1}updateBrushPreview(e){const t=e.brush;var o=e.cursorX,i=e.cursorY;t.style.width=e.brush_size*2*this.zoom_ratio+"px",t.style.height=e.brush_size*2*this.zoom_ratio+"px",t.style.left=o-e.brush_size*this.zoom_ratio+"px",t.style.top=i-e.brush_size*this.zoom_ratio+"px"}handleWheelEvent(e,t){t.preventDefault(),t.ctrlKey?(t.deltaY<0?this.zoom_ratio=Math.min(10,this.zoom_ratio+.2):this.zoom_ratio=Math.max(.2,this.zoom_ratio-.2),this.invalidatePanZoom()):(t.deltaY<0?this.brush_size=Math.min(this.brush_size+2,100):this.brush_size=Math.max(this.brush_size-2,1),this.brush_slider_input.value=this.brush_size.toString(),this.updateBrushPreview(this))}pointMoveEvent(e,t){this.cursorX=t.pageX,this.cursorY=t.pageY,e.updateBrushPreview(e),t.ctrlKey&&(t.preventDefault(),e.pan_move(e,t));let o=window.TouchEvent&&t instanceof TouchEvent||t.buttons==1;if(t.shiftKey&&o){e.drawing_mode=!1;const i=t.clientY;let n=(e.zoom_lasty-i)*.005;e.zoom_ratio=Math.max(Math.min(10,e.last_zoom_ratio-n),.2),this.invalidatePanZoom();return}}pan_move(e,t){if(t.buttons==1&&T.mousedown_x){let o=T.mousedown_x-t.clientX,i=T.mousedown_y-t.clientY;e.pan_x=this.mousedown_pan_x-o,e.pan_y=this.mousedown_pan_y-i,e.invalidatePanZoom()}}draw_move(e,t){if(t.ctrlKey||t.shiftKey)return;t.preventDefault(),this.cursorX=t.pageX,this.cursorY=t.pageY,e.updateBrushPreview(e);let o=window.TouchEvent&&t instanceof TouchEvent||t.buttons==1,i=[2,5,32].includes(t.buttons);if(!t.altKey&&o){var n=performance.now()-e.lasttime;const c=e.maskCanvas.getBoundingClientRect();var a=t.offsetX,r=t.offsetY;t.offsetX==null&&(a=t.targetTouches[0].clientX-c.left),t.offsetY==null&&(r=t.targetTouches[0].clientY-c.top),a/=e.zoom_ratio,r/=e.zoom_ratio;var l=this.brush_size;t instanceof PointerEvent&&t.pointerType=="pen"?(l*=t.pressure,this.last_pressure=t.pressure):window.TouchEvent&&t instanceof TouchEvent&&n<20?l*=this.last_pressure:l=this.brush_size,n>20&&!this.drawing_mode?requestAnimationFrame(()=>{e.init_shape(e,"source-over"),e.draw_shape(e,a,r,l),e.lastx=a,e.lasty=r}):requestAnimationFrame(()=>{e.init_shape(e,"source-over");for(var d=a-e.lastx,h=r-e.lasty,b=Math.sqrt(d*d+h*h),p=d/b,f=h/b,m=0;m<b;m+=5){var y=e.lastx+p*m,w=e.lasty+f*m;e.draw_shape(e,y,w,l)}e.lastx=a,e.lasty=r}),e.lasttime=performance.now()}else if(t.altKey&&o||i){const c=e.maskCanvas.getBoundingClientRect(),d=(t.offsetX||t.targetTouches[0].clientX-c.left)/e.zoom_ratio,h=(t.offsetY||t.targetTouches[0].clientY-c.top)/e.zoom_ratio;var l=this.brush_size;t instanceof PointerEvent&&t.pointerType=="pen"?(l*=t.pressure,this.last_pressure=t.pressure):window.TouchEvent&&t instanceof TouchEvent&&n<20?l*=this.last_pressure:l=this.brush_size,n>20&&!this.drawing_mode?requestAnimationFrame(()=>{e.init_shape(e,"destination-out"),e.draw_shape(e,d,h,l),e.lastx=d,e.lasty=h}):requestAnimationFrame(()=>{e.init_shape(e,"destination-out");for(var p=d-e.lastx,f=h-e.lasty,m=Math.sqrt(p*p+f*f),y=p/m,w=f/m,C=0;C<m;C+=5){var _=e.lastx+y*C,I=e.lasty+w*C;e.draw_shape(e,_,I,l)}e.lastx=d,e.lasty=h}),e.lasttime=performance.now()}}handlePointerDown(e,t){if(t.ctrlKey){t.buttons==1&&(T.mousedown_x=t.clientX,T.mousedown_y=t.clientY,this.mousedown_pan_x=this.pan_x,this.mousedown_pan_y=this.pan_y);return}var o=this.brush_size;if(t instanceof PointerEvent&&t.pointerType=="pen"&&(o*=t.pressure,this.last_pressure=t.pressure),[0,2,5].includes(t.button)){if(e.drawing_mode=!0,t.preventDefault(),t.shiftKey){e.zoom_lasty=t.clientY,e.last_zoom_ratio=e.zoom_ratio;return}const i=e.maskCanvas.getBoundingClientRect(),n=(t.offsetX||t.targetTouches[0].clientX-i.left)/e.zoom_ratio,a=(t.offsetY||t.targetTouches[0].clientY-i.top)/e.zoom_ratio;!t.altKey&&t.button==0?e.init_shape(e,"source-over"):e.init_shape(e,"destination-out"),e.draw_shape(e,n,a,o),e.lastx=n,e.lasty=a,e.lasttime=performance.now()}}init_shape(e,t){e.maskCtx.beginPath(),t=="source-over"?(e.maskCtx.fillStyle=this.getMaskFillStyle(),e.maskCtx.globalCompositeOperation="source-over"):t=="destination-out"&&(e.maskCtx.globalCompositeOperation="destination-out")}draw_shape(e,t,o,i){e.pointer_type==="rect"?e.maskCtx.rect(t-i,o-i,i*2,i*2):e.maskCtx.arc(t,o,i,0,Math.PI*2,!1),e.maskCtx.fill()}async save(){const e=document.createElement("canvas"),t=e.getContext("2d",{willReadFrequently:!0});e.width=this.image.width,e.height=this.image.height,t.clearRect(0,0,e.width,e.height),t.drawImage(this.maskCanvas,0,0,this.maskCanvas.width,this.maskCanvas.height,0,0,e.width,e.height);const o=t.getImageData(0,0,e.width,e.height);for(let p=0;p<o.data.length;p+=4)o.data[p+3]==255?o.data[p+3]=0:o.data[p+3]=255,o.data[p]=0,o.data[p+1]=0,o.data[p+2]=0;t.globalCompositeOperation="source-over",t.putImageData(o,0,0);const i=new FormData,n="clipspace-mask-"+performance.now()+".png",a={filename:n,subfolder:"clipspace",type:"input"};if(N.clipspace.images&&(N.clipspace.images[0]=a),N.clipspace.widgets){const p=N.clipspace.widgets.findIndex(f=>f.name==="image");p>=0&&(N.clipspace.widgets[p].value=a)}const r=e.toDataURL(),l=ro(r);let c=new URL(this.image.src);const d={filename:c.searchParams.get("filename")};let h=c.searchParams.get("subfolder");h&&(d.subfolder=h);let b=c.searchParams.get("type");b&&(d.type=b),i.append("image",l,n),i.append("original_ref",JSON.stringify(d)),i.append("type","input"),i.append("subfolder","clipspace"),this.saveButton.innerText="Saving...",this.saveButton.disabled=!0,await co(a,i),N.onClipspaceEditorSave(),this.close()}}window.comfyAPI=window.comfyAPI||{};window.comfyAPI.maskEditorOld=window.comfyAPI.maskEditorOld||{};window.comfyAPI.maskEditorOld.MaskEditorDialogOld=T;function po(s){if(!s){console.error("[MaskEditor] No node provided");return}if(!s.imgs?.length&&s.previewMediaType!=="image"){console.error("[MaskEditor] Node has no images");return}if(g.extensionManager.setting.get("Comfy.MaskEditor.UseNewEditor"))Ot().openMaskEditor(s);else{N.copyToClipspace(s),N.clipspace_return_node=s;const t=T.getInstance();t?.isOpened&&!t.isOpened()&&t.show()}}u(po,"openMaskEditor");function ho(){return g.extensionManager.setting.get("Comfy.MaskEditor.UseNewEditor")?ot().isDialogOpen("global-mask-editor"):T.instance?.isOpened?.()??!1}u(ho,"isOpened");g.registerExtension({name:"Comfy.MaskEditor",settings:[{id:"Comfy.MaskEditor.UseNewEditor",category:["Mask Editor","NewEditor"],name:"Use new mask editor",tooltip:"Switch to the new mask editor interface",type:"boolean",defaultValue:!0,experimental:!0},{id:"Comfy.MaskEditor.BrushAdjustmentSpeed",category:["Mask Editor","BrushAdjustment","Sensitivity"],name:"Brush adjustment speed multiplier",tooltip:"Controls how quickly the brush size and hardness change when adjusting. Higher values mean faster changes.",experimental:!0,type:"slider",attrs:{min:.1,max:2,step:.1},defaultValue:1,versionAdded:"1.0.0"},{id:"Comfy.MaskEditor.UseDominantAxis",category:["Mask Editor","BrushAdjustment","UseDominantAxis"],name:"Lock brush adjustment to dominant axis",tooltip:"When enabled, brush adjustments will only affect size OR hardness based on which direction you move more",type:"boolean",defaultValue:!0,experimental:!0}],commands:[{id:"Comfy.MaskEditor.OpenMaskEditor",icon:"pi pi-pencil",label:"Open Mask Editor for Selected Node",function:u(()=>{const s=g.canvas.selected_nodes;if(!s||Object.keys(s).length!==1)return;const e=s[Object.keys(s)[0]];po(e)},"function")},{id:"Comfy.MaskEditor.BrushSize.Increase",icon:"pi pi-plus-circle",label:"Increase Brush Size in MaskEditor",function:u(()=>qe(s=>q.clamp(s+4,1,100)),"function")},{id:"Comfy.MaskEditor.BrushSize.Decrease",icon:"pi pi-minus-circle",label:"Decrease Brush Size in MaskEditor",function:u(()=>qe(s=>q.clamp(s-4,1,100)),"function")}],init(){const s=u(()=>{if(!g.extensionManager.setting.get("Comfy.MaskEditor.UseNewEditor")){const o=T.getInstance();o?.isOpened&&!o.isOpened()&&o.show()}},"openMaskEditorFromClipspace"),e=u(()=>!!(N.clipspace&&N.clipspace.imgs&&N.clipspace.imgs.length>0),"context_predicate");S.registerButton("MaskEditor",e,s)}});const qe=u(async s=>{if(!ho())return;const e=Mt(),t=e.brushSettings.size,o=s(t);e.setBrushSize(o)},"changeBrushSize"),Ce="COMFY_MATCHTYPE_V3";g.registerExtension({name:"Comfy.MatchType",beforeRegisterNodeDef(s,e){const t={...e.input?.required,...e.input?.optional};Object.values(t).some(o=>o[0]===Ce)&&(s.prototype.onNodeCreated=ee(s.prototype.onNodeCreated,function(){const o={},i={};for(const n of this.inputs){if(n.type!==Ce)continue;const a=t[n.name][1]?.template;a&&(n.type=a.allowed_types??"*",o[a.template_id]??=[],o[a.template_id].push([n.name,n.type]))}this.outputs.forEach((n,a)=>{if(n.type!==Ce)return;const r=e.output_matchtypes?.[a];r!=null&&(i[r]??=[],i[r].push(a))});for(const n in o)go(this,o[n],i[n])}))}});function go(s,e,t){const o=new Array(e.length).fill("*");s.onConnectionsChange=ee(s.onConnectionsChange,function(i,n,a,r){const l=this.inputs[n];if(i!==k.INPUT||!this.graph||!l)return;const c=e.findIndex(([d])=>d===l.name);if(c!=-1){if(o[c]=e[c][1],a&&r){const{output:d,subgraphInput:h}=r.resolve(this.graph),b=(d??h)?.type;b&&(r.type=o[c]=b)}for(let d=0;d<e.length;d++){const h=this.inputs.find(f=>f.name===e[d][0]);if(!h)continue;const b=[...o];b.splice(d,1);const p=He(...b,e[d][1]);if(!p)throw new Error("invalid connection");h.type=p}if(t){const d=He(...o);if(!d)throw new Error("invalid connection");fo(this,d,t)}}})}u(go,"addConnectionGroup");function fo(s,e,t){if(s.graph){for(const o of t)if(s.outputs[o].type!==e){s.outputs[o].type=e;for(let i of s.outputs[o].links??[]){let n=s.graph.links[i];if(!n)continue;const{input:a,inputNode:r,subgraphOutput:l}=n.resolve(s.graph),c=(a??l)?.type;if(!c)continue;const d=k.isValidConnection(e,c);!d&&l?l.disconnect():!d&&r&&r.disconnectInput(n.target_slot),a&&r?.onConnectionsChange&&r.onConnectionsChange(k.INPUT,n.target_slot,d,n,a)}g.canvas.setDirty(!0,!0)}}}u(fo,"changeOutputType");function mo(s){return!s.some(e=>typeof e!="string")}u(mo,"isStrings");function He(...s){if(!mo(s))return;const e=Bt(s,"*");if(e.length===0)return"*";const t=e.map(i=>i.split(",")),o=yo(...t);if(o.length!==0)return o.join(",")}u(He,"combineTypes");function yo(...s){const e={};for(const t of s)for(const o of new Set(t))e[o]=(e[o]??0)+1;return Object.entries(e).filter(([,t])=>t==s.length).map(([t])=>t)}u(yo,"intersection");const wo="Comfy.NodeTemplates",Xe="comfy.templates.json";class bo extends xe{static{u(this,"ManageTemplates")}templates;draggedEl;saveVisualCue;emptyImg;importInput;constructor(){super(),this.load().then(e=>{this.templates=e}),this.element.classList.add("comfy-manage-templates"),this.draggedEl=null,this.saveVisualCue=null,this.emptyImg=new Image,this.emptyImg.src="data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAAAACwAAAAAAQABAAACAkQBADs=",this.importInput=v("input",{type:"file",accept:".json",multiple:!0,style:{display:"none"},parent:document.body,onchange:u(()=>this.importAll(),"onchange")})}createButtons(){const e=super.createButtons();return e[0].textContent="Close",e[0].onclick=()=>{clearTimeout(this.saveVisualCue),this.close()},e.unshift(v("button",{type:"button",textContent:"Export",onclick:u(()=>this.exportAll(),"onclick")})),e.unshift(v("button",{type:"button",textContent:"Import",onclick:u(()=>{this.importInput.click()},"onclick")})),e}async load(){let e=[];const t=await O.getUserData(Xe);if(t.status===200)try{e=await t.json()}catch{}else t.status!==404&&console.error(t.status+" "+t.statusText);return e??[]}async store(){const e=JSON.stringify(this.templates,void 0,4);try{await O.storeUserData(Xe,e,{stringify:!1})}catch(t){console.error(t),M().addAlert(t.message)}}async importAll(){for(const e of this.importInput.files)if(e.type==="application/json"||e.name.endsWith(".json")){const t=new FileReader;t.onload=async()=>{const o=JSON.parse(t.result);if(o?.templates){for(const i of o.templates)i?.name&&i?.data&&this.templates.push(i);await this.store()}},await t.readAsText(e)}this.importInput.value=null,this.close()}exportAll(){if(this.templates.length==0){M().addAlert(x("toastMessages.noTemplatesToExport"));return}const e=JSON.stringify({templates:this.templates},null,2),t=new Blob([e],{type:"application/json"});We("node_templates.json",t)}show(){super.show(v("div",{},this.templates.flatMap((e,t)=>{let o;return[v("div",{dataset:{id:t.toString()},className:"templateManagerRow",style:{display:"grid",gridTemplateColumns:"1fr auto",border:"1px dashed transparent",gap:"5px",backgroundColor:"var(--comfy-menu-bg)"},ondragstart:u(i=>{this.draggedEl=i.currentTarget,i.currentTarget.style.opacity="0.6",i.currentTarget.style.border="1px dashed yellow",i.dataTransfer.effectAllowed="move",i.dataTransfer.setDragImage(this.emptyImg,0,0)},"ondragstart"),ondragend:u(i=>{i.target.style.opacity="1",i.currentTarget.style.border="1px dashed transparent",i.currentTarget.removeAttribute("draggable"),this.element.querySelectorAll(".templateManagerRow").forEach((n,a)=>{var r=Number.parseInt(n.dataset.id);n==this.draggedEl&&r!=a&&this.templates.splice(a,0,this.templates.splice(r,1)[0]),n.dataset.id=a.toString()}),this.store()},"ondragend"),ondragover:u(i=>{if(i.preventDefault(),i.currentTarget==this.draggedEl)return;let n=i.currentTarget.getBoundingClientRect();i.clientY>n.top+n.height/2?i.currentTarget.parentNode.insertBefore(this.draggedEl,i.currentTarget.nextSibling):i.currentTarget.parentNode.insertBefore(this.draggedEl,i.currentTarget)},"ondragover")},[v("label",{textContent:"Name: ",style:{cursor:"grab"},onmousedown:u(i=>{i.target.localName=="label"&&(i.currentTarget.parentNode.draggable="true")},"onmousedown")},[v("input",{value:e.name,dataset:{name:e.name},style:{transitionProperty:"background-color",transitionDuration:"0s"},onchange:u(i=>{clearTimeout(this.saveVisualCue);var n=i.target,a=n.parentNode.parentNode;this.templates[a.dataset.id].name=n.value.trim()||"untitled",this.store(),n.style.backgroundColor="rgb(40, 95, 40)",n.style.transitionDuration="0s",this.saveVisualCue=setTimeout(function(){n.style.transitionDuration=".7s",n.style.backgroundColor="var(--comfy-input-bg)"},15)},"onchange"),onkeypress:u(i=>{var n=i.target;clearTimeout(this.saveVisualCue),n.style.transitionDuration="0s",n.style.backgroundColor="var(--comfy-input-bg)"},"onkeypress"),$:u(i=>o=i,"$")})]),v("div",{},[v("button",{textContent:"Export",style:{fontSize:"12px",fontWeight:"normal"},onclick:u(()=>{const i=JSON.stringify({templates:[e]},null,2),n=new Blob([i],{type:"application/json"}),a=(o.value||e.name)+".json";We(a,n)},"onclick")}),v("button",{textContent:"Delete",style:{fontSize:"12px",color:"red",fontWeight:"normal"},onclick:u(i=>{const n=i.target.parentNode.parentNode;n.parentNode.removeChild(n),this.templates.splice(n.dataset.id*1,1),this.store();var a=this;setTimeout(function(){a.element.querySelectorAll(".templateManagerRow").forEach((r,l)=>{r.dataset.id=l.toString()})},0)},"onclick")})])])]})))}}const re=new bo,Ke=u(async s=>{const e=localStorage.getItem("litegrapheditor_clipboard");await s(),localStorage.setItem("litegrapheditor_clipboard",e)},"clipboardAction"),vo={name:wo,getCanvasMenuItems(s){const e=[];e.push(null),e.push({content:"Save Selected as Template",disabled:!Object.keys(g.canvas.selected_nodes||{}).length,callback:u(async()=>{const o=await te().prompt({title:x("nodeTemplates.saveAsTemplate"),message:x("nodeTemplates.enterName"),defaultValue:""});o?.trim()&&Ke(()=>{g.canvas.copyToClipboard();let i=localStorage.getItem("litegrapheditor_clipboard");i=JSON.parse(i||"{}");const n=Object.keys(g.canvas.selected_nodes);for(let a=0;a<n.length;a++){const r=g.graph.getNodeById(n[a]),l=r?.constructor.nodeData;let c=G.getGroupData(r);if(c){if(c=c.nodeData,i.groupNodes||(i.groupNodes={}),l==null)throw new TypeError("nodeData is not set");i.groupNodes[l.name]=c,i.nodes[a].type=l.name}}re.templates.push({name:o,data:JSON.stringify(i)}),re.store()})},"callback")});const t=re.templates.map(o=>({content:o.name,callback:u(()=>{Ke(async()=>{const i=JSON.parse(o.data);await X.registerFromWorkflow(i.groupNodes,{}),i.reroutes?(localStorage.setItem("litegrapheditor_clipboard",o.data),g.canvas.pasteFromClipboard()):tt(o.data,g.canvas)})},"callback")}));return t.push(null,{content:"Manage",callback:u(()=>re.show(),"callback")}),e.push({content:"Node Templates",submenu:{options:t}}),e}};g.registerExtension(vo);g.registerExtension({name:"Comfy.NoteNode",registerCustomNodes(){class s extends le{static{u(this,"NoteNode")}static category;static collapsable;static title_mode;color=B.node_colors.yellow.color;bgcolor=B.node_colors.yellow.bgcolor;groupcolor=B.node_colors.yellow.groupcolor;isVirtualNode;constructor(o){super(o),this.properties||(this.properties={text:""}),j.STRING(this,"text",["STRING",{default:this.properties.text,multiline:!0}],g),this.serialize_widgets=!0,this.isVirtualNode=!0}}k.registerNodeType("Note",Object.assign(s,{title_mode:k.NORMAL_TITLE,title:"Note",collapsable:!0})),s.category="utils";class e extends le{static{u(this,"MarkdownNoteNode")}static title="Markdown Note";color=B.node_colors.yellow.color;bgcolor=B.node_colors.yellow.bgcolor;groupcolor=B.node_colors.yellow.groupcolor;constructor(o){super(o),this.properties||(this.properties={text:""}),j.MARKDOWN(this,"text",["STRING",{default:this.properties.text}],g),this.serialize_widgets=!0,this.isVirtualNode=!0}}k.registerNodeType("MarkdownNote",e),e.category="utils"}});ae().registerExtension({name:"Comfy.PreviewAny",async beforeRegisterNodeDef(s,e){if(e.name==="PreviewAny"){const t=s.prototype.onNodeCreated;s.prototype.onNodeCreated=function(){t&&t.apply(this,[]);const i=j.MARKDOWN(this,"preview",["MARKDOWN",{}],g).widget;i.options.read_only=!0,i.element.readOnly=!0,i.element.disabled=!0,i.serialize=!1};const o=s.prototype.onExecuted;s.prototype.onExecuted=function(i){o?.apply(this,[i]);const n=this.widgets?.find(a=>a.name==="preview");n&&(n.value=i.text[0])}}}});g.registerExtension({name:"Comfy.RerouteNode",registerCustomNodes(s){class e extends le{static{u(this,"RerouteNode")}static category;static defaultVisibility=!1;constructor(o){super(o??""),this.properties||(this.properties={}),this.properties.showOutputText=e.defaultVisibility,this.properties.horizontal=!1,this.addInput("","*"),this.addOutput(this.properties.showOutputText?"*":"","*"),this.isVirtualNode=!0}onAfterGraphConfigured(){requestAnimationFrame(()=>{this.onConnectionsChange(k.INPUT,void 0,!0)})}clone(){const o=super.clone();return o&&(o.removeOutput(0),o.addOutput(this.properties.showOutputText?"*":"","*"),o.setSize(o.computeSize()),o)}onConnectionsChange(o,i,n){const{graph:a}=this;if(!a||s.configuringGraph)return;if(n&&o===k.OUTPUT&&new Set(this.outputs[0].links?.map(C=>a.links[C]?.type)?.filter(C=>C&&C!=="*")??[]).size>1){const C=[];for(const _ of this.outputs[0].links??[]){const I=a.links[_];C.push(I)}C.pop();for(const _ of C)a.getNodeById(_.target_id)?.disconnectInput(_.target_slot)}let r=this,l=[],c=null,d=null;for(;r;){l.unshift(r);const w=r.inputs[0].link;if(w!==null){const C=a.links[w];if(!C)return;const _=a.getNodeById(C.origin_id);if(!_)return;if(_ instanceof e)_===this?(r.disconnectInput(C.target_slot),r=null):r=_;else{d=r,c=_.outputs[C.origin_slot]?.type??null;break}}else{r=null;break}}const h=[this];let b=null;for(;h.length;){r=h.pop();const w=r.outputs?.[0]?.links??[];for(const C of w){const _=a.links[C];if(!_)continue;const I=a.getNodeById(_.target_id);if(I)if(I instanceof e)h.push(I),l.push(I);else{const D=I.inputs[_.target_slot],E=D.type,A=!c||!E||k.isValidConnection(c,E);if(!A){I.disconnectInput(_.target_slot);continue}I.onConnectionsChange?.(k.INPUT,_.target_slot,A,_,D),b=I.inputs[_.target_slot].type}}}const p=c||b||"*",f=B.link_type_colors[p];let m,y;for(const w of l){w.outputs[0].type=c||"*",w.__outputType=p,w.outputs[0].name=w.properties.showOutputText?`${p}`:"",w.setSize(w.computeSize());for(const C of w.outputs[0].links||[]){const _=a.links[C];if(!_||(_.color=f,s.configuringGraph))continue;const I=a.getNodeById(_.target_id);if(!I)continue;const D=I.inputs?.[_.target_slot];if(D?.widget){const E=Oe(D);m||(m=E[1]??{},y=E[0]);const A=se(D,[E[0],m]);A.customConfig&&(m=A.customConfig)}}}for(const w of l)m&&b?(w.inputs[0].widget={name:"value"},Ne(w.inputs[0],[y??`${p}`,m])):Ne(w.inputs[0],void 0);if(d?.inputs?.[0]?.link){const w=a.links[d.inputs[0].link];w&&(w.color=f)}}getExtraMenuOptions(o,i){return i.unshift({content:(this.properties.showOutputText?"Hide":"Show")+" Type",callback:u(()=>{this.properties.showOutputText=!this.properties.showOutputText,this.properties.showOutputText?this.outputs[0].name=`${this.__outputType||this.outputs[0].type}`:this.outputs[0].name="",this.setSize(this.computeSize()),s.canvas.setDirty(!0,!0)},"callback")},{content:(e.defaultVisibility?"Hide":"Show")+" Type By Default",callback:u(()=>{e.setDefaultTextVisibility(!e.defaultVisibility)},"callback")}),[]}computeSize(){return[this.properties.showOutputText&&this.outputs&&this.outputs.length?Math.max(75,k.NODE_TEXT_SIZE*this.outputs[0].name.length*.6+40):75,26]}static setDefaultTextVisibility(o){e.defaultVisibility=o,o?localStorage["Comfy.RerouteNode.DefaultVisibility"]="true":delete localStorage["Comfy.RerouteNode.DefaultVisibility"]}}e.setDefaultTextVisibility(!!localStorage["Comfy.RerouteNode.DefaultVisibility"]),k.registerNodeType("Reroute",Object.assign(e,{title_mode:k.NO_TITLE,title:"Reroute",collapsable:!1})),e.category="utils"}});const Co=new Set(["SaveImage","SaveVideo","SaveAnimatedWEBP","SaveWEBM","SaveAudio","SaveGLB","SaveAnimatedPNG","CLIPSave","VAESave","ModelSave","LoraSave","SaveLatent"]);g.registerExtension({name:"Comfy.SaveImageExtraOutput",async beforeRegisterNodeDef(s,e,t){if(Co.has(e.name)){const o=s.prototype.onNodeCreated;s.prototype.onNodeCreated=function(){const i=o?o.apply(this,arguments):void 0,n=this.widgets.find(a=>a.name==="filename_prefix");return n.serializeValue=()=>et(t.graph,n.value),i}}else{const o=s.prototype.onNodeCreated;s.prototype.onNodeCreated=function(){const i=o?o.apply(this,arguments):void 0;return(!this.properties||!("Node name for S&R"in this.properties))&&this.addProperty("Node name for S&R",this.constructor.type,"string"),i}}}});const Je={name:"image",type:"Preview3D",isPreview:!0};ae().registerExtension({name:"Comfy.SaveGLB",async beforeRegisterNodeDef(s,e){e.name==="SaveGLB"&&(e.input.required.image=["PREVIEW_3D"])},getCustomWidgets(){return{PREVIEW_3D(s){const e=new De({node:s,name:Je.name,component:Se,inputSpec:Je,options:{}});return e.type="load3D",Te(s,e),{widget:e}}}},getNodeMenuItems(s){if(s.constructor.comfyClass!=="SaveGLB")return[];const e=de().getLoad3d(s);return e?he(e):[]},async nodeCreated(s){if(s.constructor.comfyClass!=="SaveGLB")return;const[e,t]=s.size;s.setSize([Math.max(e,400),Math.max(t,550)]),await Ee();const o=s.onExecuted;s.onExecuted=function(i){o?.apply(this,arguments);const n=i["3d"][0];ne(s).waitForLoad3d(a=>{const r=s.widgets?.find(l=>l.name==="image");if(a&&r){const l=n.subfolder+"/"+n.filename;r.value=l,new Ae(a,s.properties).configureForSaveMesh(n.type,l)}})}}});function _o(s,e){const t=e.selectedItems;if(t.size<=1)return;const o=At(t,10);if(!o)return;const[i,n,a,r]=o;s.save();const l=2/e.ds.scale;s.lineWidth=l,s.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue("--border-color").trim()||"#ffffff66";const c=5/e.ds.scale;s.setLineDash([c,c]),s.beginPath(),s.roundRect(i,n,a,r,8/e.ds.scale),s.stroke(),s.restore()}u(_o,"drawSelectionBorder");const ko={name:"Comfy.SelectionBorder",async init(){const s=g.canvas.onDrawForeground;g.canvas.onDrawForeground=function(e,t){s?.call(this,e,t),_o(e,g.canvas)}}};g.registerExtension(ko);let ue=!1,pe=0;g.registerExtension({name:"Comfy.SimpleTouchSupport",setup(){let s=null,e=null,t=null,o=null;function i(a){return Math.hypot(a.touches[0].clientX-a.touches[1].clientX,a.touches[0].clientY-a.touches[1].clientY)}u(i,"getMultiTouchPos");function n(a){return{clientX:(a.touches[0].clientX+a.touches[1].clientX)/2,clientY:(a.touches[0].clientY+a.touches[1].clientY)/2}}u(n,"getMultiTouchCenter"),g.canvasEl.parentElement?.addEventListener("touchstart",a=>{pe+=a.changedTouches.length,t=null,o=null,a.touches?.length===1?(e=new Date,t=a.touches[0]):(e=null,a.touches?.length===2&&(o=g.canvas.ds.scale,t=n(a),s=i(a),g.canvas.pointer.isDown=!1))},!0),g.canvasEl.parentElement?.addEventListener("touchend",a=>{if(pe-=a.changedTouches.length,a.touches?.length!==1&&(ue=!1),e&&!a.touches?.length){if(new Date().getTime()-e.getTime()>600&&a.target===g.canvasEl){const r={button:2,clientX:a.changedTouches[0].clientX,clientY:a.changedTouches[0].clientY,pointerId:1,isPrimary:!0};g.canvasEl.dispatchEvent(new PointerEvent("pointerdown",r)),setTimeout(()=>{g.canvasEl.dispatchEvent(new PointerEvent("pointerup",r))}),a.preventDefault()}e=null}}),g.canvasEl.parentElement?.addEventListener("touchmove",a=>{if(e&&t&&a.touches?.length===1){const c=a.touches[0],d=c.clientX-t.clientX,h=c.clientY-t.clientY;d*d+h*h>30&&(e=null)}if(a.touches?.length===2&&t&&!a.ctrlKey&&!a.shiftKey){a.preventDefault(),g.canvas.pointer.isDown=!1,ue=!0,k.closeAllContextMenus(window),g.canvas.search_box?.close();const c=i(a),d=n(a);if(o===null||s===null)return;let h=o*c/s;const b=(d.clientX-t.clientX)/h,p=(d.clientY-t.clientY)/h;h<g.canvas.ds.min_scale?h=g.canvas.ds.min_scale:h>g.canvas.ds.max_scale&&(h=g.canvas.ds.max_scale);const f=g.canvas.ds.scale;g.canvas.ds.scale=h,Math.abs(g.canvas.ds.scale-1)<.01&&(g.canvas.ds.scale=1);const m=g.canvas.ds.scale,y=u(w=>[d.clientX/w-g.canvas.ds.offset[0],d.clientY/w-g.canvas.ds.offset[1]],"convertScaleToOffset");var r=y(f),l=y(m);g.canvas.ds.offset[0]+=b+l[0]-r[0],g.canvas.ds.offset[1]+=p+l[1]-r[1],t.clientX=d.clientX,t.clientY=d.clientY,g.canvas.setDirty(!0,!0)}},!0)}});const No=B.prototype.processMouseDown;B.prototype.processMouseDown=function(s){if(!(ue||pe))return g.canvas.pointer.isDown=!1,No.apply(this,[s])};const Io=B.prototype.processMouseMove;B.prototype.processMouseMove=function(s){if(!(ue||pe>1))return Io.apply(this,[s])};g.registerExtension({name:"Comfy.SlotDefaults",suggestionsNumber:null,init(){k.search_filter_enabled=!0,k.middle_click_slot_add_default_node=!0,this.suggestionsNumber=g.ui.settings.addSetting({id:"Comfy.NodeSuggestions.number",category:["Comfy","Node Search Box","NodeSuggestions"],name:"Number of nodes suggestions",tooltip:"Only for litegraph searchbox/context menu",type:"slider",attrs:{min:1,max:100,step:1},defaultValue:5,onChange:u(s=>{this.setDefaults(s)},"onChange")})},slot_types_default_out:{},slot_types_default_in:{},async beforeRegisterNodeDef(s,e){var t=e.name;const o=e.input?.required;for(const c in o){var i=o[c];if(typeof i[0]!="string")continue;var n=i[0];if(n in j){var a=i[1];if(!a?.forceInput)continue}if(n in this.slot_types_default_out||(this.slot_types_default_out[n]=["Reroute"]),this.slot_types_default_out[n].includes(t))continue;this.slot_types_default_out[n].push(t);const d=n.toLocaleLowerCase();d in k.registered_slot_in_types||(k.registered_slot_in_types[d]={nodes:[]}),k.registered_slot_in_types[d].nodes.push(s.comfyClass)}var r=e.output??[];for(const c of r){const d=c;d in this.slot_types_default_in||(this.slot_types_default_in[d]=["Reroute"]),!this.slot_types_default_in[d].includes(t)&&(this.slot_types_default_in[d].push(t),d in k.registered_slot_out_types||(k.registered_slot_out_types[d]={nodes:[]}),k.registered_slot_out_types[d].nodes.push(s.comfyClass),k.slot_types_out.includes(d)||k.slot_types_out.push(d))}var l=this.suggestionsNumber.value;this.setDefaults(l)},setDefaults(s){k.slot_types_default_out={},k.slot_types_default_in={};for(const e in this.slot_types_default_out)k.slot_types_default_out[e]=this.slot_types_default_out[e].slice(0,s);for(const e in this.slot_types_default_in)k.slot_types_default_in[e]=this.slot_types_default_in[e].slice(0,s)}});async function xo(s,e,t,o,i=!1){try{const n=new FormData;n.append("image",t),i&&n.append("subfolder","pasted");const a=await O.fetchApi("/upload/image",{method:"POST",body:n});if(a.status===200){const r=await a.json();let l=r.name;r.subfolder&&(l=r.subfolder+"/"+l),s.options.values.includes(l)||s.options.values.push(l),o&&(e.element.src=O.apiURL(ce(...it(l))),s.value=l,s.callback?.(l))}else M().addAlert(a.status+" - "+a.statusText)}catch(n){M().addAlert(n)}}u(xo,"uploadFile");g.registerExtension({name:"Comfy.AudioWidget",async beforeRegisterNodeDef(s,e){["LoadAudio","SaveAudio","PreviewAudio","SaveAudioMP3","SaveAudioOpus"].includes(s.prototype.comfyClass)&&(e.input.required.audioUI=["AUDIO_UI",{}])},getCustomWidgets(){return{AUDIO_UI(s,e){const t=document.createElement("audio");t.controls=!0,t.classList.add("comfy-audio"),t.setAttribute("name","media");const o=s.addDOMWidget(e,"audioUI",t);o.serialize=!1;const{nodeData:i}=s.constructor;if(i==null)throw new TypeError("nodeData is null");if(i.output_node){o.element.classList.add("empty-audio-widget");const a=s.onExecuted;s.onExecuted=function(r){a?.apply(this,arguments);const l=r.audio;if(!l)return;const c=l[0];o.element.src=O.apiURL(ce(c.subfolder,c.filename,c.type)),o.element.classList.remove("empty-audio-widget")}}return o.onRemove=ee(o.onRemove,()=>{o.element&&(o.element.pause(),o.element.src="",o.element.remove())}),{widget:o}}}},onNodeOutputsUpdated(s){for(const[e,t]of Object.entries(s))if("audio"in t){const o=Pt(g.graph,e);if(!o)continue;const i=o.widgets.find(a=>a.name==="audioUI"),n=t.audio[0];i.element.src=O.apiURL(ce(n.subfolder,n.filename,n.type)),i.element.classList.remove("empty-audio-widget")}}});g.registerExtension({name:"Comfy.UploadAudio",async beforeRegisterNodeDef(s,e){e?.input?.required?.audio?.[1]?.audio_upload===!0&&(e.input.required.upload=["AUDIOUPLOAD",{}])},getCustomWidgets(){return{AUDIOUPLOAD(s,e){const t=s.widgets.find(d=>d.name==="audio"),o=s.widgets.find(d=>d.name==="audioUI");o.options.canvasOnly=!0;const i=u(()=>{typeof t.value=="string"&&(o.element.src=O.apiURL(ce(...it(t.value))))},"onAudioWidgetUpdate");t.value&&i(),t.callback=i;const n=s.onGraphConfigured;s.onGraphConfigured=function(){n?.apply(this,arguments),t.value&&i()};const a=u(async d=>(d?.length&&xo(t,o,d[0],!0),d),"handleUpload"),r=u(d=>d.type.startsWith("audio/"),"isAudioFile"),{openFileSelection:l}=Lt(s,{accept:"audio/*",onSelect:a}),c=s.addWidget("button",e,"",l,{serialize:!1,canvasOnly:!0});return c.label=x("g.choose_file_to_upload"),Rt(s,{fileFilter:r,onDrop:a}),Ft(s,{fileFilter:r,onPaste:a}),s.previewMediaType="audio",{widget:c}}}}});g.registerExtension({name:"Comfy.RecordAudio",getCustomWidgets(){return{AUDIO_RECORD(s,e){const t=document.createElement("audio");t.controls=!0,t.classList.add("comfy-audio"),t.setAttribute("name","media");const o=s.addDOMWidget(e,"audioUI",t);o.options.canvasOnly=!1;let i=null,n=!1,a=[],r=null,l=null,c=null,d=null;o.serializeValue=async()=>{n&&i&&(c=new Promise(f=>{d=f}),i.stop(),await c);const b=o.element.src;if(!b)return M().addAlert(x("g.noAudioRecorded")),"";const p=await fetch(b).then(f=>f.blob());return await Z().convertBlobToFileAndSubmit(p)},l=s.addWidget("button",e,"",async()=>{if(n)i&&n&&i.stop();else try{r=await navigator.mediaDevices.getUserMedia({audio:!0}),i=new Ut(r,{mimeType:"audio/wav"}),a=[],i.ondataavailable=b=>{a.push(b.data)},i.onstop=async()=>{const b=new Blob(a,{type:"audio/wav"});Z().stopAllTracks(r),o.element.src&&o.element.src.startsWith("blob:")&&URL.revokeObjectURL(o.element.src),o.element.src=URL.createObjectURL(b),n=!1,l&&(l.label=x("g.startRecording")),d&&(d(),d=null,c=null)},i.onerror=b=>{console.error("MediaRecorder error:",b),Z().stopAllTracks(r),n=!1,l&&(l.label=x("g.startRecording")),d&&(d(),d=null,c=null)},i.start(),n=!0,l&&(l.label=x("g.stopRecording"))}catch(b){if(console.error("Error accessing microphone:",b),M().addAlert(x("g.micPermissionDenied")),i)try{i.stop()}catch{}Z().stopAllTracks(r),r=null,n=!1,l&&(l.label=x("g.startRecording"))}},{serialize:!1,canvasOnly:!1}),l.label=x("g.startRecording"),l.type="audiorecord";const h=s.onRemoved;return s.onRemoved=function(){n&&i&&i.stop(),Z().stopAllTracks(r),o.element.src?.startsWith("blob:")&&URL.revokeObjectURL(o.element.src),h?.call(this)},{widget:l}}}},async nodeCreated(s){s.constructor.comfyClass==="RecordAudio"&&await Z().registerWavEncoder()}});const Do=u(s=>{const[e,t]=s;return t?(t.image_upload===!0||t.video_upload===!0||t.animated_image_upload===!0)&&(Wt(s)||e==="COMBO"):!1},"isMediaUploadComboInput"),To=u((s,e)=>["IMAGEUPLOAD",{...e[1],imageInputName:s}],"createUploadInput");g.registerExtension({name:"Comfy.UploadImage",beforeRegisterNodeDef(s,e){const{input:t}=e??{},{required:o}=t??{};if(!o)return;const i=Object.entries(o).find(([n,a])=>Do(a));if(i){const[n,a]=i;o.upload=To(n,a)}}});const Ze=Symbol();g.registerExtension({name:"Comfy.WebcamCapture",getCustomWidgets(){return{WEBCAM(s,e){let t;s[Ze]=new Promise(a=>t=a);const o=document.createElement("div");o.style.background="rgba(0,0,0,0.25)",o.style.textAlign="center";const i=document.createElement("video");return i.style.height=i.style.width="100%",u(async()=>{try{const a=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});o.replaceChildren(i),setTimeout(()=>t(i),500),i.addEventListener("loadedmetadata",()=>t(i),!1),i.srcObject=a,i.play()}catch(a){const r=document.createElement("div");r.style.color="red",r.style.overflow="auto",r.style.maxHeight="100%",r.style.whiteSpace="pre-wrap",window.isSecureContext?r.textContent=`Unable to load webcam, please ensure access is granted:
`+a.message:r.textContent=`Unable to load webcam. A secure context is required, if you are not accessing ComfyUI on localhost (127.0.0.1) you will have to enable TLS (https)

`+a.message,o.replaceChildren(r)}},"loadVideo")(),{widget:s.addDOMWidget(e,"WEBCAM",o)}}}},nodeCreated(s){if(s.type,s.constructor.comfyClass!=="WebcamCapture")return;let e;const t=s.widgets.find(c=>c.name==="image"),o=s.widgets.find(c=>c.name==="width"),i=s.widgets.find(c=>c.name==="height"),n=s.widgets.find(c=>c.name==="capture_on_queue"),a=document.createElement("canvas"),r=u(()=>{a.width=o.value,a.height=i.value,a.getContext("2d").drawImage(e,0,0,o.value,i.value);const d=a.toDataURL("image/png"),h=new Image;h.onload=()=>{s.imgs=[h],g.graph.setDirtyCanvas(!0)},h.src=d},"capture"),l=s.addWidget("button","waiting for camera...","capture",r,{canvasOnly:!0});l.disabled=!0,l.serializeValue=()=>{},t.serializeValue=async()=>{if(n.value)r();else if(!s.imgs?.length){const f="No webcam image captured";throw M().addAlert(f),new Error(f)}const c=await new Promise(f=>a.toBlob(f)),d=`${+new Date}.png`,h=new File([c],d),b=new FormData;b.append("image",h),b.append("subfolder","webcam"),b.append("type","temp");const p=await O.fetchApi("/upload/image",{method:"POST",body:b});if(p.status!==200){const f=`Error uploading camera image: ${p.status} - ${p.statusText}`;throw M().addAlert(f),new Error(f)}return`webcam/${d} [temp]`},s[Ze].then(c=>{e=c,o.value||(o.value=e.videoWidth||640,i.value=e.videoHeight||480),l.disabled=!1,l.label=x("g.capture")})}});
//# sourceMappingURL=index-B4KuK9HZ.js.map
